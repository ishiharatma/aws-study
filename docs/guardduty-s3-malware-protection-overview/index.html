
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>GuardDuty Malware Protection for S3</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="G-01ZZ95D1K9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="guardduty-s3-malware-protection-overview"
                  title="GuardDuty Malware Protection for S3"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="☘️ はじめに" duration="0">
        <p>本ページは、AWS に関する個人の勉強および勉強会で使用することを目的に、AWS ドキュメントなどを参照し作成しておりますが、記載の誤り等が含まれる場合がございます。</p>
<p>最新の情報については、AWS 公式ドキュメントをご参照ください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="👀 Contents" duration="0">
        <ul>
<li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB" target="_blank">はじめに</a></li>
<li><a href="#malware-protection-for-s3-%E3%81%A8%E3%81%AF" target="_blank">Malware Protection for S3 とは</a></li>
<li><a href="#%E4%BB%95%E7%B5%84%E3%81%BF" target="_blank">仕組み</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" target="_blank">使用方法</a></li>
<li><a href="#s3-%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%B9%E3%82%AD%E3%83%A3%E3%83%B3%E7%B5%90%E6%9E%9C%E3%81%AE%E5%80%A4" target="_blank">S3 オブジェクトスキャン結果の値</a></li>
<li><a href="#%E3%82%BF%E3%82%B0%E4%BB%98%E3%81%91%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB" target="_blank">タグ付けとアクセスコントロール</a><ul>
<li><a href="#%E3%82%BF%E3%82%B0%E4%BB%98%E3%81%91" target="_blank">タグ付け</a></li>
<li><a href="#%E3%82%BF%E3%82%B0%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB-tbac" target="_blank">タグベースのアクセスコントロール (TBAC)</a></li>
</ul>
</li>
<li><a href="#%E8%A9%B3%E7%B4%B0%E3%81%AA%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D%E6%96%B9%E6%B3%95" target="_blank">詳細な結果の確認方法</a></li>
<li><a href="#%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%96%B9%E6%B3%95" target="_blank">マルウェアテストの方法</a></li>
<li><a href="#aws-cdk-%E3%81%A7%E3%81%AE%E5%AE%9F%E8%A3%85%E4%BE%8B" target="_blank">AWS CDK での実装例</a></li>
<li><a href="#-%E3%81%BE%E3%81%A8%E3%82%81" target="_blank">📖 まとめ</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="はじめに" duration="0">
        <p>クラウドセキュリティは今日のデジタル世界において最重要課題の一つです。特に、Amazon S3 のようなクラウドストレージサービスでは、マルウェア対策が不可欠です。本記事では、AWS GuardDuty の機能である Malware Protection for S3 について詳しく解説します。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Malware Protection for S3 とは" duration="0">
        <p>選択した Amazon Simple Storage Service (Amazon S3) バケットに新しくアップロードされたオブジェクトをスキャンして、マルウェアの潜在的な存在を検出する機能です。この機能により、クラウドストレージ内のデータセキュリティを効果的に強化することができます。</p>
<p>【AWS Black Belt Online Seminar】<a href="https://youtu.be/GwzBiO1jBvU" target="_blank">Amazon GuardDuty Malware Protection(YouTube)</a>(0:43:53)</p>
<p class="image-container"><img alt="blackbelt-guardduty-malware" src="img\\5f96981244faefca.jpg"></p>
<p><a href="https://www.youtube.com/watch?v=uweeumMAif4" target="_blank">GuardDuty Malware Protection for S3 - Overview and Demo | Amazon Web Services(YouTube)</a>(0:09:30)</p>
<p class="image-container"><img alt="malware-protection" src="img\\c80f280d637ad3ba.jpg"></p>
<p><a href="https://aws.amazon.com/jp/blogs/aws/introducing-amazon-guardduty-malware-protection-for-amazon-s3/" target="_blank">Malware Protection for S3 サービス概要</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/gdu-malware-protection-s3.html" target="_blank">Malware Protection for S3 ドキュメント(GuardDuty)</a></p>
<p><a href="https://aws.amazon.com/jp/guardduty/faqs/" target="_blank">Amazon GuardDuty よくある質問</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/pricing-malware-protection-for-s3-guardduty.html" target="_blank">Malware Protection for S3 料金(GuardDuty)</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="仕組み" duration="0">
        <p><a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/how-malware-protection-for-s3-gdu-works.html" target="_blank">仕組み</a>に記載がありますが、Amazon GuardDuty Best Practices にある<a href="https://aws.github.io/aws-security-services-best-practices/guides/guardduty/#s3-malware-protection-automation-workflow" target="_blank">S3 Malware Protection automation workflow</a>の図が分かりやすいため引用します。</p>
<p class="image-container"><img alt="GD-S3-Automation-Workflow.png" src="img\\f71285607b95d551.png"></p>
<ol type="1">
<li>ファイルアップロード：ユーザーが S3 バケットにファイルをアップロードします。</li>
<li>イベント通知：アップロードイベントが Amazon EventBridge に通知されます。</li>
<li>ファイルコピーとスキャン実行：GuardDuty が動作する別の AWS アカウント内の隔離環境に、AWS PrivateLink 経由でファイルがコピーされ、オブジェクトを復号、スキャンします。コピー先は DuardDuty が動作する 別の AWS アカウント内の同一リージョン上です。</li>
<li>結果通知：スキャン結果が Amazon EventBridge に通知されます。</li>
<li>メトリクス送信：CloudWatch にスキャン結果のメトリクスが送信されます。</li>
<li>タグ付け：オプションが有効な場合、元の S3 オブジェクトにスキャン結果のタグが付けられます。</li>
<li>検出結果送信：GuardDuty が有効な場合、詳細な検出結果が送信されます。</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="使用方法" duration="0">
        <p>Malware Protection for S3 の設定は非常にシンプルです。以下の手順で簡単に開始できます。</p>
<ol type="1">
<li>GuardDuty または Malware Protection for S3 を有効化します。<ul>
<li>スキャン結果のみが必要な場合は「Malware Protection for S3」のみを有効化します。</li>
<li>詳細な検出結果が必要な場合は、「GuardDuty」を有効化します。 <img alt="setup" src="img\\b0352a432206c58f.png"></li>
</ul>
</li>
<li>スキャン対象の S3 バケットを指定します。 <img alt="setup2" src="img\\81bb5ee16ad5f99d.png"></li>
<li>ステータスが「Active」になれば設定完了です。 <img alt="setup3" src="img\\bb32554707e92544.png"></li>
</ol>
<p>これらの手順により、選択した S3 バケット内の新規アップロードファイルに対して自動的にマルウェアスキャンが実行されるようになります。</p>


      </google-codelab-step>
    
      <google-codelab-step label="S3 オブジェクトスキャン結果の値" duration="0">
        <p>GuardDuty によってスキャンされた結果は以下の５つの値となります。</p>
<ol type="1">
<li>NO_THREATS_FOUND： GuardDuty で潜在的な脅威が検出されなかったファイル ≒ 正常なファイル</li>
<li>THREATS_FOUND： GuardDuty で潜在的な脅威が検出されたファイル</li>
<li>UNSUPPORTED： GuardDuty でサポートされていないためスキャンが出来なかったファイル。詳細は、<a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/malware-protection-s3-quotas-guardduty.html" target="_blank">Malware Protection for S3 のクォータ</a>を参照。</li>
<li>ACCESS_DENIED： GuardDuty がスキャンするためのアクセス権限がなくスキャンが出来なかったファイル。「<a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/malware-protection-s3-iam-policy-prerequisite.html" target="_blank">前提条件 - IAM PassRole ポリシーを作成または更新する</a>」を参照。</li>
<li>FAILED： GuardDuty 内部エラーのため、スキャンが出来なかったファイル</li>
</ol>
<p>これらの結果は、Amazon EventBridge のイベントとして記録されます。(詳細は、<a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/monitor-with-eventbridge-s3-malware-protection.html#set-up-malware-protection-s3-eventbridge-rules" target="_blank">Amazon EventBridge の使用＞ S3 オブジェクトスキャン結果</a>を参照）</p>
<pre><code language="language-json" class="language-json">&#34;scanResultDetails&#34;: {
    &#34;scanResultStatus&#34;: &#34;THREATS_FOUND&#34;,
    &#34;threats&#34;: [
        {
            &#34;name&#34;: &#34;EICAR-Test-File (not a virus)&#34;
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="タグ付けとアクセスコントロール" duration="0">
        <p>タグ付け機能を活用することで、スキャン結果に基づいたアクセスコントロールが可能になります。</p>
<h2 is-upgraded>タグ付け</h2>
<p><a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/monitor-enable-s3-object-tagging-malware-protection.html" target="_blank">タグ付けを有効</a>にすると、「<a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/monitoring-malware-protection-s3-scans-gdu.html#s3-object-scan-result-value-malware-protection" target="_blank">GuardDutyMalwareScanStatus</a>」というタグが S3 オブジェクトに付与されます。このタグにはスキャン結果の値が保持されます。</p>
<p>ただし、タグ付けについては Malware Protection for S3 の無料枠に含まれないことに注意が必要です。 タグ付けにかかるコストについては、<a href="https://aws.amazon.com/jp/s3/pricing/" target="_blank">S3 料金</a>の「管理とインサイト」タブに記載があります。</p>
<pre><code language="language-text" class="language-text">※ アジアパシフィック（東京）
S3 オブジェクトのタグ付け: 月あたり 10,000 タグにつき 0.01USD
</code></pre>
<h2 is-upgraded>タグベースのアクセスコントロール (TBAC)</h2>
<p>TBAC を利用すると、スキャン結果に基づいて S3 オブジェクトへのアクセスを制御できます。例えば、以下のような S3 バケットリソースポリシーを設定することで、安全でないファイルへのアクセスを拒否できます。（詳細は、<a href="https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/tag-based-access-s3-malware-protection.html" target="_blank">S3 バケットリソースポリシーの例</a>を参照）</p>
<pre><code language="language-json" class="language-json">&#34;Effect&#34;: &#34;Deny&#34;,
&#34;Action&#34;: [
    &#34;s3:GetObject&#34;,
    &#34;s3:GetObjectVersion&#34;
],
&#34;Resource&#34;: [
    &#34;arn:aws:s3:::DOC-EXAMPLE-BUCKET&#34;,
    &#34;arn:aws:s3:::DOC-EXAMPLE-BUCKET/*&#34;
],
&#34;Condition&#34;: {
    &#34;StringNotEquals&#34;: {
        &#34;s3:ExistingObjectTag/GuardDutyMalwareScanStatus&#34;: &#34;NO_THREATS_FOUND&#34;
    }
}
</code></pre>
<p>ただし、このポリシーの設定には注意が必要です。不適切な設定により、GuardDuty 自体のスキャンが「ACCESS_DENIED」となる可能性があります。</p>


      </google-codelab-step>
    
      <google-codelab-step label="詳細な結果の確認方法" duration="0">
        <p>より詳細なスキャン結果を確認するには、GuardDuty を有効化する必要があります。 有効化すると、右上に「S3 マルウェアのすべての検出結果を表示」ボタンが表示されるようになり、詳細が確認できます。</p>
<p class="image-container"><img alt="details" src="img\\232e7c710f8de0e.png"></p>
<p>このような検出結果が表示されます。</p>
<p class="image-container"><img alt="result1" src="img\\e18cd2316726820a.png"></p>
<p>選択することでさらに詳細が確認できます。</p>
<p class="image-container"><img alt="result2" src="img\\e06f50448645fcf6.png"><img alt="result3" src="img\\bd675baadff84269.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="マルウェアテストの方法" duration="0">
        <p>実際のマルウェアを使用したテストは危険です。代わりに、EICAR (European Institute for Computer Antivirus Research)が公開している EICAR テストファイルを使用することをお勧めします。このファイルは無害ですが、多くのアンチウイルスソフトウェアによってマルウェアとして検出されます。</p>
<p>EICAR テストファイルは <a href="https://www.eicar.org/download-anti-malware-testfile/" target="_blank">EICAR 公式サイト</a>からダウンロードできます。このファイルを S3 バケットにアップロードすることで、Malware Protection for S3 の動作を安全にテストできます。</p>
<p class="image-container"><img alt="eicar" src="img\\b48466f2bbe2dd10.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="AWS CDK での実装例" duration="0">
        <p>AWS CDK での実装例です。以下のリポジトリを参照してください。</p>
<p><a href="https://github.com/ishiharatma/aws-cdk-cdp/tree/main/usecases/s3-malware-protection#readme" target="_blank">GitHub&gt;ishiharatma/aws-cdk-cdp/usecases /s3-malware-protection</a></p>
<p class="image-container"><img alt="github-overview" src="img\\ab3c1edcdd6c883a.png"></p>
<pre><code language="language-ts" class="language-ts">:
const malwareProtection = new guardduty.CfnMalwareProtectionPlan(this, &#39;malwareProtectionPlan&#39;, {
    protectedResource: {
    s3Bucket: {
        bucketName: targetBucket.bucketName,
    },
    },
    actions: {
    tagging: {
        status: &#39;ENABLED&#39;
    }
    },
    role: guardDutyRole.roleArn,
});
:
const malwareProtectionEvents = new cwe.Rule(this, &#39;RuleMalwareProtectionGuardDuty&#39;, {
    description: &#39;CloudWatch Event Rule to send notification from GuardDuty Malware Protection.&#39;,
    enabled: true,
    eventPattern: {
        source: [&#39;aws.guardduty&#39;],
        detailType: [&#39;GuardDuty Malware Protection Object Scan Result&#39;],
        detail: {
            scanResultDetails: {
            scanResultStatus: [&#39;THREATS_FOUND&#39;, &#39;UNSUPPORTED&#39;, &#39;ACCESS_DENIED&#39;,&#39;FAILED&#39;],
            },
        },
    },
    //targets: [new cwet.SnsTopic(snsTopic)],
});
</code></pre>
<p>現在は 安全と判定されたもの以外を SNS に通知しているのみですが、以下のカスタマイズも可能です。</p>
<ul>
<li>イベントパターンをスキャン結果ごとに作成し、処理を分ける</li>
<li>Lambda と連携し、「脅威が検出されたファイルを別の S3 バケットに隔離または削除」する</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="📖 まとめ" duration="0">
        <p>GuardDuty Malware Protection for S3 は、クラウドストレージのセキュリティを強化する強力なツールです。本記事で解説した機能や設定方法、ベストプラクティスを活用することで、組織のデータを効果的に保護し、セキュリティリスクを最小限に抑えることができます。</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
