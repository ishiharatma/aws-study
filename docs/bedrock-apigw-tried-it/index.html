
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Amazon Bedrock ã‚’åˆ©ç”¨ã—ãŸç”»åƒç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ AWS CDK ã§é–‹ç™ºã—ã¦ã¿ãŸï¼</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="G-01ZZ95D1K9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="bedrock-apigw-tried-it"
                  title="Amazon Bedrock ã‚’åˆ©ç”¨ã—ãŸç”»åƒç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ AWS CDK ã§é–‹ç™ºã—ã¦ã¿ãŸï¼"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="â˜˜ï¸ ã¯ã˜ã‚ã«" duration="0">
        <p>æœ¬ãƒšãƒ¼ã‚¸ã¯ã€AWS ã«é–¢ã™ã‚‹å€‹äººã®å‹‰å¼·ãŠã‚ˆã³å‹‰å¼·ä¼šã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«ã€AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’å‚ç…§ã—ä½œæˆã—ã¦ãŠã‚Šã¾ã™ãŒã€è¨˜è¼‰ã®èª¤ã‚Šç­‰ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚</p>
<p>æœ€æ–°ã®æƒ…å ±ã«ã¤ã„ã¦ã¯ã€AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="ğŸ‘€ Contents" duration="0">
        <ul>
<li><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88" target="_blank">å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ</a></li>
<li><a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96" target="_blank">ãƒ¢ãƒ‡ãƒ«ã®æœ‰åŠ¹åŒ–</a></li>
<li><a href="#api-gateway--lambda-%E3%81%AE-rest-api" target="_blank">API Gateway + Lambda ã® REST API</a><ul>
<li><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89" target="_blank">ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰</a></li>
<li><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E8%A7%A3%E8%AA%AC" target="_blank">ã‚³ãƒ¼ãƒ‰ã®è§£èª¬</a></li>
<li><a href="#%E5%AE%9F%E8%A1%8C" target="_blank">å®Ÿè¡Œ</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81" target="_blank">ã¾ã¨ã‚</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ" duration="0">
        <p>ã“ã®ã‚µã‚¤ãƒˆã®å†…å®¹ã‚’å‚è€ƒã«ã—ã¦ã€AWS CDK ã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ <a href="https://aws.amazon.com/jp/builders-flash/202402/bedrock-image-generation/?awsf.filter-name=*all" target="_blank">Amazon Bedrock ã‚’åˆ©ç”¨ã—ã¦ã€ç”»åƒç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã—ã¦ã¿ãŸï¼ | builders.flash</a></p>
<p>å…¨ä½“ã®æ§‹æˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
<p class="image-container"><img alt="overview" src="img\\ceda78dca67a8447.png"></p>
<p>å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆã§ã¯ã€ç°¡æ˜“çš„ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€ä»Šå› CDK ã§å®Ÿè£…ã™ã‚‹ã®ã¯ API Gateway ã¾ã§ã¨ã—ã¦ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="ãƒ¢ãƒ‡ãƒ«ã®æœ‰åŠ¹åŒ–" duration="0">
        <p>ã¾ãšã¯ãƒ¢ãƒ‡ãƒ«ã®æœ‰åŠ¹åŒ–ã‚’ã—ã¾ã™ã€‚</p>
<ol type="1">
<li>AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ã€ŒBedrockã€ã‚’é¸æŠã—ã¾ã™ã€‚</li>
<li>ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã—ã¾ã™ã€‚ â€»æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€åŸ·ç­†æ™‚ç‚¹ï¼ˆ2024.3.29ï¼‰ã§åˆ©ç”¨ã§ãã‚‹ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>
<li>å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼ãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç®¡ç†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚<img alt="model-access" src="img\\2554288e386ee5bb.png"></li>
<li>Stability AI ã® SDXL1.0 ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚<img alt="model-access" src="img\\a21a724b994670d3.png">æš«ãã™ã‚‹ã¨ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚<img alt="model-access" src="img\\fa78b7ef01b0f9ed.png"><img alt="model-access" src="img\\e9a65ed5a76bcfbf.png"></li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="API Gateway &#43; Lambda ã® REST API" duration="0">
        <h2 is-upgraded>ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰</h2>
<p><a href="https://github.com/ishiharatma/aws-handson-apigw-bedrock" target="_blank">aws-handson-apigw-bedrock | GitHub</a></p>
<h2 is-upgraded>ã‚³ãƒ¼ãƒ‰ã®è§£èª¬</h2>
<ul>
<li>ç”»åƒä¿å­˜ç”¨ã® S3 ä½œæˆ</li>
</ul>
<pre><code language="language-ts" class="language-ts">// lib/aws-handson-apigw-bedrock-stack.ts
const resultS3Bucket = new s3.Bucket(this, &#34;BedrockResultBucket&#34;, {
  bucketName: [props.pjName, props.envName, baseName, accountId].join(&#34;.&#34;),
  accessControl: s3.BucketAccessControl.PRIVATE,
  blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
  removalPolicy: cdk.RemovalPolicy.DESTROY,
  autoDeleteObjects: true,
  encryption: s3.BucketEncryption.KMS_MANAGED,
});
</code></pre>
<ul>
<li>Lambda ã®ä½œæˆ</li>
</ul>
<p><code>src/lambda/handson-bedrock</code> ã«ã‚ã‚‹ã‚½ãƒ¼ã‚¹ã‚’ã¾ã‚‹ã”ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ ç’°å¢ƒå¤‰æ•°ã§ã€çµæœã‚’æ ¼ç´ã™ã‚‹ S3 ãƒã‚±ãƒƒãƒˆåã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code language="language-ts" class="language-ts">const bedrockLambdaFunction = new lambda.Function(
  this,
  &#34;bedrockLambdaFunction&#34;,
  {
    functionName: [props.pjName, props.envName, baseName].join(&#34;-&#34;),
    code: lambda.Code.fromAsset(
      path.join(__dirname, `${srcLambdaDirBase}/handson-bedrock`)
    ),
    handler: &#34;index.lambda_handler&#34;,
    runtime: lambda.Runtime.PYTHON_3_12,
    timeout: cdk.Duration.seconds(25),
    architecture: lambda.Architecture.ARM_64, //X86_64,
    environment: {
      S3_BUCKET_NAME: resultS3Bucket.bucketName,
      LOG_LEVEL: &#34;INFO&#34;,
    },
    role: bedrockLambdaFunctionRole,
    //tracing: lambda.Tracing.ACTIVE,
  }
);
</code></pre>
<p>Lambda å†…ã§å®Ÿéš›ã« Bedrock ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã‚‹éƒ¨åˆ†ã¯ä¸‹è¨˜ã§ã™ã€‚</p>
<pre><code language="language-python" class="language-python"># Amazon Bedrockã§ç”¨æ„ã—ãŸåŸºç›¤ãƒ¢ãƒ‡ãƒ«ã¸APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€ç”»åƒã‚’ç”Ÿæˆã™ã‚‹
response = bedrock_runtime.invoke_model(
    body=&#39;{&#34;text_prompts&#34;: [{&#34;text&#34;:&#34;&#39;+input_text+&#39;&#34;}]}&#39;,
    contentType=&#39;application/json&#39;,
    accept=&#39;image/png&#39;,
    modelId=&#39;stability.stable-diffusion-xl-v1&#39;
    )
</code></pre>
<ul>
<li>Rest API ã®ä½œæˆ</li>
</ul>
<pre><code language="language-ts" class="language-ts">// lib/aws-handson-apigw-bedrock-stack.ts
const restApi = new apigw.RestApi(this, &#39;APIGateway&#39;, {
    restApiName: restApiName,
    policy: resourcePolicy,
    endpointTypes: [apigw.EndpointType.REGIONAL],
    :
    },
});
//API Gatewayã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ 
const restApiBedrock = restApi.root.addResource(&#39;bedrock&#39;);
restApiBedrock.addMethod(
  &#39;POST&#39;,
  new apigw.LambdaIntegration(bedrockLambdaFunction)
);
</code></pre>
<h2 is-upgraded>å®Ÿè¡Œ</h2>
<p>å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚</p>
<pre><code language="language-bat" class="language-bat">curl -X POST https://xxxxx.execute-api.us-east-1.amazonaws.com/v1/bedrock ^
-H &#34;Content-Type: application/json&#34; -d &#34;{\&#34;input_text\&#34;:\&#34;an image of cat\&#34;}&#34;
</code></pre>
<p>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ç½²åä»˜ã URL ãŒè¿”ã£ã¦ãã¾ã™ã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ç”»åƒãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
<pre><code language="language-text" class="language-text">{&#34;presigned_url&#34;: &#34;https://s3.amazonaws.com/xxxxxx&#34;}
</code></pre>
<p>ãŸã ã—ã€çµµç”»ã£ã½ã„ã§ã™ã€‚</p>
<p class="image-container"><img alt="result1" src="img\\8caa89d096592873.jpg"></p>
<p>å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆã§ã¯ã‚‚ã£ã¨ãƒªã‚¢ãƒ«ãªçŒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p class="image-container"><img alt="handson-image" src="img\\99e5f9407c021674.jpg"></p>
<p>ã„ã‚ã„ã‚èª¿ã¹ã¦ã„ã‚‹ã¨ã€ã‚‚ã†å°‘ã—æŒ‡ç¤ºã‚’å¢—ã‚„ã—ãŸæ–¹ãŒè‰¯ã„ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã£ãŸã®ã§ä»˜ã‘è¶³ã—ã¦ã¿ã¾ã™ã€‚ ã€Œwith a photo-realisticã€ã¨ã„ã†ã®ã‚’æœ€å¾Œã«ä»˜ã‘è¶³ã—ã¾ã™ã€‚</p>
<pre><code language="language-bat" class="language-bat">curl -X POST https://xxxxx.execute-api.us-east-1.amazonaws.com/v1/bedrock ^
-H &#34;Content-Type: application/json&#34; -d &#34;{\&#34;input_text\&#34;:\&#34;an image of cat with a photo-realistic.\&#34;}&#34;
</code></pre>
<p>ãƒªã‚¢ãƒ«ãªçŒ«ã®ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p>
<p class="image-container"><img alt="result2" src="img\\18a04ecbac0d4b33.jpg"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ã¾ã¨ã‚" duration="0">
        <p>å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆã§ã¯ã€æ‰‹ä½œæ¥­ã§ä½œæˆã—ã¦ã„ã¾ã™ãŒã€CDK ã‚’ä½¿ã†ã“ã¨ã§å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰æ™‚ã«è¿‘ã„ã“ã¨ã‚’å®Ÿç¿’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ ãŸã ã€Amazon Bedrock è‡ªä½“ã«å¯¾ã™ã‚‹çŸ¥è­˜ã¯ã¾ã ã¾ã è¶³ã‚Šã¦ã„ãªã„ã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ã£ã¨å‹‰å¼·ã—ã¦ã„ã‚ã„ã‚ãªã“ã¨ã«æŒ‘æˆ¦ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
