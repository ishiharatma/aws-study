
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>AWS Security Hub</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="G-01ZZ95D1K9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="securityhub-overview"
                  title="AWS Security Hub"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="☘️ はじめに" duration="0">
        <p>本ページは、AWS に関する個人の勉強および勉強会で使用することを目的に、AWS ドキュメントなどを参照し作成しておりますが、記載の誤り等が含まれる場合がございます。</p>
<p>最新の情報については、AWS 公式ドキュメントをご参照ください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="👀 Contents" duration="0">
        <ul>
<li><a href="#aws-security-hub-%E3%81%A8%E3%81%AF" target="_blank">AWS Security Hub とは</a></li>
<li><a href="#%E7%89%B9%E5%BE%B4" target="_blank">特徴</a></li>
<li><a href="#security-hub-%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96" target="_blank">Security Hub の有効化</a></li>
<li><a href="#%E6%A4%9C%E5%87%BA%E9%A0%85%E7%9B%AE%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB" target="_blank">検出項目（コントロール）</a></li>
<li><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%AA%E3%83%B3%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB" target="_blank">サービスリンクロール</a></li>
<li><a href="#%E3%82%AF%E3%83%AD%E3%82%B9%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E9%9B%86%E7%B4%84" target="_blank">クロスリージョン集約</a></li>
<li><a href="#%E6%A4%9C%E5%87%BA%E7%B5%90%E6%9E%9C%E9%80%9A%E7%9F%A5" target="_blank">検出結果通知</a><ul>
<li><a href="#compliance" target="_blank">Compliance</a></li>
<li><a href="#severity" target="_blank">Severity</a></li>
<li><a href="#aws-foundational-security-best-practices%E3%81%AE%E3%81%BF" target="_blank">「AWS Foundational Security Best Practices」のみ</a></li>
</ul>
</li>
<li><a href="#security-hub-%E8%87%AA%E5%8B%95%E5%BF%9C%E7%AD%94%E3%81%A8%E4%BF%AE%E5%BE%A9" target="_blank">Security Hub 自動応答と修復</a></li>
<li><a href="#-%E3%81%BE%E3%81%A8%E3%82%81" target="_blank">📖 まとめ</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="AWS Security Hub とは" duration="0">
        <p>AWS Security Hub とは、Cloud Security Posture Management（CSPM：クラウドセキュリティの構成ミス、管理不備などへ対応するための仕組み）に相当するサービスで、「AWS リソースのセキュリティ設定がベストプラクティスから逸脱していないか」を自動でチェックします。</p>
<p>【AWS Black Belt Online Seminar】<a href="https://www.youtube.com/watch?v=1JJw9efXIlw" target="_blank">AWS Security Hub(YouTube)</a>(1:02:06) <a href="https://d1.awsstatic.com/webinars/jp/pdf/services/20201013_AWS-BlackBelt-AWSSecurityHub.pdf" target="_blank">pdf</a></p>
<p class="image-container"><img alt="blackbelt-securityhub" src="img\\422d5de145fab42a.jpg"></p>
<p><a href="https://aws.amazon.com/jp/security-hub/" target="_blank">AWS Security Hub サービス概要</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/?id=docs_gateway" target="_blank">AWS Security Hub ドキュメント</a></p>
<p><a href="https://aws.amazon.com/jp/security-hub/faqs/" target="_blank">AWS Security Hub よくある質問</a></p>
<p><a href="https://aws.amazon.com/jp/security-hub/pricing/" target="_blank">AWS Security Hub の料金</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="特徴" duration="0">
        <ul>
<li>30 日間は無料</li>
<li>Security Hub はリージョンサービス</li>
<li>全てのリージョンで有効化することを推奨 <ul>
<li>AWS Config が有効化されている必要がある</li>
<li>全リージョンで有効化するには、CLI や CDK などで効率化する</li>
</ul>
</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Security Hub の有効化" duration="0">
        <p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-settingup.html" target="_blank">AWS Security Hub の設定</a></p>
<p>AWS Organizations のアカウントでは Security Hub が自動的に有効になります。 それ以外のアカウントでは、手動で有効化する必要がありますが、有効化はコンソールで簡単に実施することができます。 AWS Security Hub を有効化する前に、AWS Config でリソースの記録を有効にする必要があります。</p>
<p class="image-container"><img alt="securityhub-setup" src="img\\21da876f030e5766.png"></p>
<p>Security Hub はリージョンサービスであるため、リージョン毎に有効化する必要があります。</p>
<p>有効化したものを無効にすることもできます。 <a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-disable.html#securityhub-disable-console" target="_blank">Security Hub を無効にする</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="検出項目（コントロール）" duration="0">
        <p>検出項目はコントロールとよばれ、次のようなものがあります。</p>
<pre><code language="language-text" class="language-text">[Account.1] AWS アカウント について、セキュリティの連絡先情報を提供する必要があります
[IAM.4] IAM ルートユーザーアクセスキーが存在してはいけません
</code></pre>
<p>コントロールは、すでに用意されているものから選択することができます。</p>
<p class="image-container"><img alt="securityhub-controls" src="img\\73622c90edf552d2.png"></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/fsbp-standard.html" target="_blank">AWS Foundational Security Best Practices (FSBP) 標準</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/cis-aws-foundations-benchmark.html" target="_blank">Center for Internet Security (CIS) AWS Foundations Benchmark v1.2.0 および v1.4.0</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/nist-standard.html" target="_blank">米国国立標準技術研究所 (NIST) SP 800-53 Rev. 5</a></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/pci-standard.html" target="_blank">PCI DSS</a></p>
<p>それぞれで検出される項目の詳細は次を参照します。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-controls-reference.html" target="_blank">Security Hub コントロールのリファレンス</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="サービスリンクロール" duration="0">
        <p><code>AWSServiceRoleForSecurityHub</code> という名前のロールをサービスリンクロールとして使用します。 コンソールで Security Hub を有効化した場合は、<code>securityhub.amazonaws.com</code> のサービスにリンクしたロールが自動的に作成されます。</p>
<p>手動で作成することもできます。手動で作成する方法は、<a href="https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/using-service-linked-roles.html#create-service-linked-role" target="_blank">サービスにリンクされたロールの作成</a> を参照してください。</p>
<p>作成したサービスリンクロールは、ロールを使用するすべてのリージョンの Security Hub が無効化された後でしか削除できません。</p>


      </google-codelab-step>
    
      <google-codelab-step label="クロスリージョン集約" duration="0">
        <p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/finding-aggregation-enable.html" target="_blank">クロスリージョン集約を有効にする</a><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/finding-aggregation-stop.html" target="_blank">クロスリージョン集約を停止する</a></p>
<p>Security Hub はリージョンサービスです。そのため、各リージョンの検出結果は各リージョンで確認しなければなりません。 しかし、クロスリージョン集約を使うことで、1 つのリージョンに集約して管理することができます。</p>
<p class="image-container"><img alt="Aggregation Region" src="img\\189e5f5b2060e95c.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="検出結果通知" duration="0">
        <p>検出結果通知は、Security Hub から Amazon EventBridge に発信されるイベントを検出し、SNS と連携することで実現できます。</p>
<p>Security Hub から 発信される <a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-cwe-event-formats.html" target="_blank">EventBridge イベント形式</a> は次のようになります。</p>
<pre><code language="language-json" class="language-json">{
   &#34;version&#34;:&#34;0&#34;,
   &#34;id&#34;:&#34;CWE-event-id&#34;,
   &#34;detail-type&#34;:&#34;Security Hub Findings - Imported&#34;,
   &#34;source&#34;:&#34;aws.securityhub&#34;,
   &#34;account&#34;:&#34;111122223333&#34;,
   &#34;time&#34;:&#34;2019-04-11T21:52:17Z&#34;,
   &#34;region&#34;:&#34;us-west-2&#34;,
   &#34;resources&#34;:[
      &#34;arn:aws:securityhub:us-west-2::product/aws/macie/arn:aws:macie:us-west-2:111122223333:integtest/trigger/6294d71b927c41cbab915159a8f326a3/alert/f2893b211841&#34;
   ],
   &#34;detail&#34;:{
      &#34;findings&#34;: [{
         &lt;finding content&gt;
       }]
   }
}
</code></pre>
<p>上記のようなイベントを検出できるように、EventBridge の<a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-cwe-all-findings.html#securityhub-cwe-all-findings-rule-format" target="_blank">イベントパターン</a>を定義します。定義の雛形は次のとおりです。</p>
<pre><code language="language-json" class="language-json">{
  &#34;source&#34;: [
    &#34;aws.securityhub&#34;
  ],
  &#34;detail-type&#34;: [
    &#34;Security Hub Findings - Imported&#34;
  ],
  &#34;detail&#34;: {
    &#34;findings&#34;: {
      &lt;attribute filter values&gt;
    }
  }
}
</code></pre>
<p>通知対象を限定せずに設定を行うと大量のメールが送信される可能性があるため注意が必要です。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/fsbp-standard.html" target="_blank">AWS Foundational Security Best Practices</a> のいくつかを検出するイベントパターンの例は次のとおりです。</p>
<pre><code language="language-text" class="language-text">[IAM.4] IAM ルートユーザーアクセスキーが存在してはいけません
[IAM.6] ルートユーザーに対してハードウェア MFA を有効にする必要があります
[S3.2] S3 バケットではパブリック読み取りアクセスを禁止する必要があります
[CloudTrail.1] CloudTrail を有効にして、少なくとも 1 つのマルチリージョンの追跡で、読み取りと書き込みの管理イベントを含めた設定をする必要があります。
[PCI.CloudTrail.4] CloudTrail ログファイルの検証を有効にする必要があります
</code></pre>
<pre><code language="language-json" class="language-json">{
  &#34;source&#34;: [&#34;aws.securityhub&#34;],
  &#34;detail-type&#34;: [&#34;Security Hub Findings - Imported&#34;],
  &#34;detail&#34;: {
    &#34;findings&#34;: {
      &#34;Severity&#34;: {
        &#34;Label&#34;: [&#34;HIGH&#34;, &#34;CRITICAL&#34;]
      },
      &#34;Compliance&#34;: {
        &#34;Status&#34;: [&#34;FAILED&#34;]
      },
      &#34;Workflow&#34;: {
        &#34;Status&#34;: [&#34;NEW&#34;]
      },
      &#34;RecordState&#34;: [&#34;ACTIVE&#34;],
      &#34;ProductFields&#34;: {
        &#34;StandardsArn&#34;: [
          {
            &#34;prefix&#34;: &#34;arn:aws:securityhub:::standards/aws-foundational-security-best-practices&#34;
          }
        ],
        &#34;ControlId&#34;: [
          &#34;IAM.4&#34;,
          &#34;IAM.6&#34;,
          &#34;S3.2&#34;,
          &#34;CloudTrail.1&#34;,
          &#34;PCI.CloudTrail.4&#34;
        ]
      }
    }
  }
}
</code></pre>
<p>このまま通知すると、JSON 形式の可読性の低いものになりますので、<a href="https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-transform-target-input.html" target="_blank">インプットトランスフォーマー</a>機能をつかって、整形します。</p>
<p class="image-container"><img alt="transform-target-input" src="img\\277f2b175dcfba60.png"></p>
<p>&#34;入力パス&#34; で定義する項目は、次を参考にします。</p>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-findings-format-syntax.html" target="_blank">AWS Security Finding 形式</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/asff-required-attributes.html" target="_blank">必須属性</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/asff-top-level-attributes.html" target="_blank">オプションの最上位属性</a></li>
</ul>
<p>入力パス</p>
<pre><code language="language-json" class="language-json">{
  &#34;accountId&#34;: &#34;$.detail.findings[0].AwsAccountId&#34;,
  &#34;region&#34;: &#34;$.region&#34;,
  &#34;FindingId&#34;: &#34;$.detail.findings[0].Types[0]&#34;,
  &#34;FindingDescription&#34;: &#34;$.detail.findings[0].description&#34;,
  &#34;StandardsArn&#34;: &#34;$.detail.findings[0].ProductFields.StandardsArn&#34;,
  &#34;ControlId&#34;: &#34;$.detail.findings[0].ProductFields.ControlId&#34;,
  &#34;Title&#34;: &#34;$.detail.findings[0].Title&#34;,
  &#34;ResourcesId&#34;: &#34;$.detail.findings[0].Resources[0].Id&#34;,
  &#34;ResourcesType&#34;: &#34;$.detail.findings[0].Resources[0].Type&#34;,
  &#34;Severity&#34;: &#34;$.detail.findings[0].Severity.Label&#34;,
  &#34;ComplianceStatus&#34;: &#34;$.detail.findings[0].Compliance.Status&#34;,
  &#34;Description&#34;: &#34;$.detail.findings[0].Description&#34;,
  &#34;WorkflowStatus&#34;: &#34;$.detail.findings[0].Workflow.Status&#34;,
  &#34;RemediationText&#34;: &#34;$.detail.findings[0].Remediation.Recommendation.Text&#34;,
  &#34;RemediationUrl&#34;: &#34;$.detail.findings[0].Remediation.Recommendation.Url&#34;,
  &#34;createdAt&#34;: &#34;$.createdAt&#34;
}
</code></pre>
<p>入力テンプレート</p>
<pre><code language="language-text" class="language-text">The following non-compliant (Failed) diagnostic items were discovered in SecurityHub&#39;s event rules.
account: &lt;accountId&gt;
region: &lt;region&gt;
Finding Id: &lt;FindingId&gt;
Finding Description: &lt;FindingDescription&gt;
StandardsArn: &lt;StandardsArn&gt;
ControlId: &lt;ControlId&gt;
Title: &lt;Title&gt;
ResourceType: &lt;ResourceType&gt;
ResourceId: &lt;ResourceId&gt;
Severity: &lt;Severity&gt;
ComplianceStatus: &lt;ComplianceStatus&gt;
WorkflowStatus: &lt;WorkflowStatus&gt;
RemediationText: &lt;RemediationText&gt;
RemediationUrl: &lt;RemediationUrl&gt;
createdAt: &lt;createdAt&gt;
See below for details.
https://&lt;region&gt;.console.aws.amazon.com/securityhub/home?region=&lt;region&gt;#/summary
</code></pre>
<h2 is-upgraded>Compliance</h2>
<p>Compliance の Status の意味については、<a href="https://docs.aws.amazon.com/securityhub/1.0/APIReference/API_Compliance.html" target="_blank">API_Compliance</a> を参照してください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>Status</p>
</td><td colspan="1" rowspan="1"><p>Description</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>PASSED</p>
</td><td colspan="1" rowspan="1"><p>チェックに合格</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>WARNING</p>
</td><td colspan="1" rowspan="1"><p>不足している情報がある or チェックをサポートしていない</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>FAILED</p>
</td><td colspan="1" rowspan="1"><p>1 つ以上のリソースがチェックに不合格</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>NOT_AVAILABLE</p>
</td><td colspan="1" rowspan="1"><p>サービス停止もしくは API エラーにより、チェックを実行できなかった</p>
</td></tr>
</table>
<p>合格しなかったものという条件の場合は次のようにします。</p>
<pre><code language="language-json" class="language-json">  &#34;detail&#34;: {
    &#34;findings&#34;: {
      &#34;Compliance&#34;: {
        &#34;Status&#34;: [
          {
            &#34;anything-but&#34;: &#34;PASSED&#34;
          }
        ]
      },
      :
</code></pre>
<h2 is-upgraded>Severity</h2>
<p>重要度については、<a href="https://docs.aws.amazon.com/securityhub/1.0/APIReference/API_Severity.html" target="_blank">API_Severity</a>を参考にします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>Severity</p>
</td><td colspan="1" rowspan="1"><p>Description</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>INFORMATIONAL</p>
</td><td colspan="1" rowspan="1"><p>問題が見つかりません</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>LOW</p>
</td><td colspan="1" rowspan="1"><p>この問題自体に対処する必要はありません</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>MEDIUM</p>
</td><td colspan="1" rowspan="1"><p>対処する必要がありますが、緊急ではありません</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>HIGH</p>
</td><td colspan="1" rowspan="1"><p>優先的に対処する必要はあります</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>CRITICAL</p>
</td><td colspan="1" rowspan="1"><p>最優先で対処する必要があります</p>
</td></tr>
</table>
<p>対処が必要な重要度だけとする条件は次のとおりです。</p>
<pre><code language="language-json" class="language-json">  &#34;detail&#34;: {
    &#34;findings&#34;:
:
        &#34;Severity&#34;: {
           &#34;Label&#34;: [
             &#34;CRITICAL&#34;,
             &#34;HIGH&#34;
           ]
        },
:
</code></pre>
<h2 is-upgraded>「AWS Foundational Security Best Practices」のみ</h2>
<p>その他のセキュリティ標準を指定する場合は、<a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/sample-control-findings.html#sample-finding-fsbp" target="_blank">コントロールの検出結果のサンプル</a>を参考にします。</p>
<pre><code language="language-json" class="language-json">  &#34;detail&#34;: {
    &#34;findings&#34;:
      {
        &#34;ProductFields&#34;:{
          &#34;StandardsArn&#34;: [
            &#34;arn:aws:securityhub:::standards/aws-foundational-security-best-practices/v/1.0.0&#34;
          ]
        },
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Security Hub 自動応答と修復" duration="0">
        <p><a href="https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-cloudwatch-events.html" target="_blank">自動応答および自動修復</a></p>
<p>Amazon EventBridge を使用して、つぎのようなリソースを自動的にトリガーすることで自動修復などを行うことができます。</p>
<ul>
<li>Lambda</li>
<li>Run Command</li>
<li>Step Functions</li>
<li>など</li>
</ul>
<p>次のサイトには、Step Functions を利用したメンバーアカウントの自動修復が説明されています。 <a href="https://aws.amazon.com/jp/solutions/implementations/automated-security-response-on-aws/" target="_blank">AWS ソリューションライブラリ &gt; AWS での自動化されたセキュリティ対応</a></p>
<p class="image-container"><img alt="automated-security-response-on-aws_architecture_diagram.png" src="img\\75615a55dbe4eae9.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="📖 まとめ" duration="0">
        <p class="image-container"><img alt="security-hub" src="img\\bfb924210e9c8b0.png"></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
