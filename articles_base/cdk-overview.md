# AWS CDK<!-- omit in toc -->

![icon](/images/icons/64/Arch_AWS-Cloud-Development-Kit_64.png)

## â˜˜ï¸ ã¯ã˜ã‚ã«<!-- omit in toc -->

æœ¬ãƒšãƒ¼ã‚¸ã¯ã€AWS ã«é–¢ã™ã‚‹å€‹äººã®å‹‰å¼·ãŠã‚ˆã³å‹‰å¼·ä¼šã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«ã€AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’å‚ç…§ã—ä½œæˆã—ã¦ãŠã‚Šã¾ã™ãŒã€è¨˜è¼‰ã®èª¤ã‚Šç­‰ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚

æœ€æ–°ã®æƒ…å ±ã«ã¤ã„ã¦ã¯ã€AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚

## ğŸ‘€ Contents<!-- omit in toc -->

- [1. AWS CDK ã¨ã¯](#1-aws-cdk-ã¨ã¯)
  - [1.1. å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](#11-å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
  - [1.2. å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹](#12-å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹)
  - [1.3. ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—](#13-ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—)
  - [1.4. å°å…¥ã®ãƒ¡ãƒªãƒƒãƒˆ](#14-å°å…¥ã®ãƒ¡ãƒªãƒƒãƒˆ)
    - [1. å‹å®‰å…¨æ€§ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼æ¤œå‡º](#1-å‹å®‰å…¨æ€§ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼æ¤œå‡º)
    - [2. ã‚³ãƒ¼ãƒ‰å†åˆ©ç”¨ã«ã‚ˆã‚‹å“è³ªå‘ä¸Šã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›](#2-ã‚³ãƒ¼ãƒ‰å†åˆ©ç”¨ã«ã‚ˆã‚‹å“è³ªå‘ä¸Šã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›)
    - [3. é–‹ç™ºç”Ÿç”£æ€§ã®å‘ä¸Š](#3-é–‹ç™ºç”Ÿç”£æ€§ã®å‘ä¸Š)
    - [4. ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®çµ±åˆ](#4-ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®çµ±åˆ)
    - [5. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¨ã‚¬ãƒãƒŠãƒ³ã‚¹ã®å¼·åŒ–](#5-ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¨ã‚¬ãƒãƒŠãƒ³ã‚¹ã®å¼·åŒ–)
  - [1.5. CloudFormationã¨ã®é•ã„](#15-cloudformationã¨ã®é•ã„)
  - [è£œè¶³ï¼šãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦](#è£œè¶³ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦)
- [2. AWS CDKã®åŸºç¤](#2-aws-cdkã®åŸºç¤)
  - [2.1. AWS CDK ã®æ§‹æˆè¦ç´ ](#21-aws-cdk-ã®æ§‹æˆè¦ç´ )
    - [2.1.1. App](#211-app)
    - [2.1.2. Stack(s)](#212-stacks)
    - [2.1.3. Construct](#213-construct)
      - [L1 Construct](#l1-construct)
      - [L2 Construct](#l2-construct)
      - [L3 Construct](#l3-construct)
  - [2.2. AWS CDK ã®ã‚³ãƒãƒ³ãƒ‰](#22-aws-cdk-ã®ã‚³ãƒãƒ³ãƒ‰)
    - [2.2.1. cdk init](#221-cdk-init)
    - [2.2.2. cdk bootstrap](#222-cdk-bootstrap)
    - [2.2.3. cdk deploy](#223-cdk-deploy)
    - [2.2.4. cdk diff](#224-cdk-diff)
    - [2.2.5. cdk synth](#225-cdk-synth)
    - [2.2.6. cdk destroy](#226-cdk-destroy)
    - [2.2.7. cdk list / cdk ls](#227-cdk-list--cdk-ls)
  - [2.3. CDKã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³](#23-cdkã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
    - [2.3.1. CDK v2](#231-cdk-v2)
    - [2.3.2.ï¼ˆ2025/2/3è¿½è¨˜ï¼‰AWS CDK ã¯ AWS CDK CLI ã¨ CDK ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ†é›¢](#232202523è¿½è¨˜aws-cdk-ã¯-aws-cdk-cli-ã¨-cdk-ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ†é›¢)
- [3. AWS CDK ã§ã®é–‹ç™ºæ–¹æ³•](#3-aws-cdk-ã§ã®é–‹ç™ºæ–¹æ³•)
  - [3.1. AWS CDKé–‹ç™ºã«å¿…è¦ãªã‚‚ã®](#31-aws-cdké–‹ç™ºã«å¿…è¦ãªã‚‚ã®)
    - [3.1.1. çŸ¥è­˜](#311-çŸ¥è­˜)
    - [3.1.2. ç’°å¢ƒ](#312-ç’°å¢ƒ)
  - [3.2. å€‹äººçš„AWS CDKã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#32-å€‹äººçš„aws-cdkã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
  - [3.3. ã‚¹ã‚¿ãƒƒã‚¯ã®åˆ†å‰²æ–¹æ³•](#33-ã‚¹ã‚¿ãƒƒã‚¯ã®åˆ†å‰²æ–¹æ³•)
    - [3.3.1. ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã§å›°ã‚‹ã“ã¨](#331-ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã§å›°ã‚‹ã“ã¨)
  - [3.4. Construct ID ã®å‘½åè¦å‰‡](#34-construct-id-ã®å‘½åè¦å‰‡)
    - [ãƒ«ãƒ¼ãƒ«â‘ ï¼šConstruct IDã¯`PascalCase`ã‚’æ¨å¥¨ã™ã‚‹](#ãƒ«ãƒ¼ãƒ«construct-idã¯pascalcaseã‚’æ¨å¥¨ã™ã‚‹)
    - [ãƒ«ãƒ¼ãƒ«â‘¡ï¼šConstruct IDã¯`ã‚·ãƒ³ãƒ—ãƒ«ãªåç§°`ã¨ã™ã‚‹](#ãƒ«ãƒ¼ãƒ«construct-idã¯ã‚·ãƒ³ãƒ—ãƒ«ãªåç§°ã¨ã™ã‚‹)
    - [ãƒ«ãƒ¼ãƒ«â‘¢ï¼šåˆ¥ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™å ´åˆã€`åŒã˜æ„å‘³`ã®Construct IDã‚’ä»˜ä¸ã—ãªã„](#ãƒ«ãƒ¼ãƒ«åˆ¥ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™å ´åˆåŒã˜æ„å‘³ã®construct-idã‚’ä»˜ä¸ã—ãªã„)
  - [3.x. Construct ID ã«é–¢ã™ã‚‹ä½™è«‡](#3x-construct-id-ã«é–¢ã™ã‚‹ä½™è«‡)
    - [3.x.1. Construct ID ã‹ã‚‰è«–ç†IDã«ã©ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã‹ï¼Ÿ](#3x1-construct-id-ã‹ã‚‰è«–ç†idã«ã©ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã‹)
- [4. AWS CDK ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•](#4-aws-cdk-ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•)
  - [4.1. Snapshot test](#41-snapshot-test)
  - [4.2. Unit Test(Fine-grained Assertions)](#42-unit-testfine-grained-assertions)
      - [è¨˜è¿°ä¾‹â‘ ï¼šå˜ç´”ãªãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯](#è¨˜è¿°ä¾‹å˜ç´”ãªãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯)
      - [è¨˜è¿°ä¾‹â‘¡ï¼šå±æ€§å€¤ã®ãƒã‚§ãƒƒã‚¯](#è¨˜è¿°ä¾‹å±æ€§å€¤ã®ãƒã‚§ãƒƒã‚¯)
- [5. AWS CDK Tips](#5-aws-cdk-tips)
  - [5.1. Appå®šç¾©ã®Tips](#51-appå®šç¾©ã®tips)
    - [5.1.1. å…±é€šã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€æ‹¬ã§ä»˜ä¸ã—ãŸã„](#511-å…±é€šã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€æ‹¬ã§ä»˜ä¸ã—ãŸã„)
    - [5.1.2. CDKã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«å‹•çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã„](#512-cdkã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«å‹•çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã„)
    - [5.1.3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ãŸç’°å¢ƒè­˜åˆ¥å­ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„](#513-ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ãŸç’°å¢ƒè­˜åˆ¥å­ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„)
    - [5.1.4. æœ¬ç•ªç’°å¢ƒï¼ˆprodï¼‰ãƒªãƒªãƒ¼ã‚¹æ™‚ã«æ³¨æ„å–šèµ·ã—ã¦ãƒŸã‚¹ã‚’é˜²æ­¢ç­–ã—ãŸã„](#514-æœ¬ç•ªç’°å¢ƒprodãƒªãƒªãƒ¼ã‚¹æ™‚ã«æ³¨æ„å–šèµ·ã—ã¦ãƒŸã‚¹ã‚’é˜²æ­¢ç­–ã—ãŸã„)
    - [5.1.5. ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤ã‚’é˜²æ­¢ã—ãŸã„](#515-ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤ã‚’é˜²æ­¢ã—ãŸã„)
    - [5.1.6. ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æŒ‡å®šã‚’å¤‰æ•°åŒ–](#516-ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æŒ‡å®šã‚’å¤‰æ•°åŒ–)
    - [5.1.7. ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤](#517-ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤)
  - [5.2. AWS CDK Tips ãã®ä»–Tips](#52-aws-cdk-tips-ãã®ä»–tips)
    - [5.2.1. ç’°å¢ƒè­˜åˆ¥å­ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã®äºŒé‡æŒ‡å®šã‚’ã‚„ã‚ã‚‹](#521-ç’°å¢ƒè­˜åˆ¥å­ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã®äºŒé‡æŒ‡å®šã‚’ã‚„ã‚ã‚‹)
    - [5.2.2. AWS CDK ä½œæˆæ™‚ã® Metadata ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ](#522-aws-cdk-ä½œæˆæ™‚ã®-metadata-ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ)
- [6. cdk-nagã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®å¼·åŒ–](#6-cdk-nagã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®å¼·åŒ–)
  - [6.1. cdk-nagã¨ã¯](#61-cdk-nagã¨ã¯)
  - [6.2. å°å…¥æ–¹æ³•](#62-å°å…¥æ–¹æ³•)
  - [6.3. å®Ÿè£…æ–¹æ³•](#63-å®Ÿè£…æ–¹æ³•)
  - [6.4. Rules Pack](#64-rules-pack)
  - [6.5. ã‚¨ãƒ©ãƒ¼ã®æŠ‘æ­¢](#65-ã‚¨ãƒ©ãƒ¼ã®æŠ‘æ­¢)
  - [6.6. ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ–¹æ³•](#66-ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ–¹æ³•)
  - [6.7. ã€ç™ºå±•ã€‘CDK-NAGã¸ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ](#67-ç™ºå±•cdk-nagã¸ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ )
- [ğŸ“– ã¾ã¨ã‚](#-ã¾ã¨ã‚)

## 1. AWS CDK ã¨ã¯

AWS Cloud Development Kit ã®ã“ã¨ã§ã€ä½¿ã„æ…£ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

AWS CDKã‚’å­¦ç¿’ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

### 1.1. å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

AWS CDKã‚’ç†è§£ã™ã‚‹å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

[AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ](https://aws.amazon.com/jp/cdk/)

[AWS CDK Reference Documentation](https://docs.aws.amazon.com/cdk/api/v2/)

[AWS CDK DEVELOPER GUIDE](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)

[AWS CDK API REFERENCE](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html)

[AWS Cloud Development Kit ã®ã‚ˆãã‚ã‚‹è³ªå•](https://aws.amazon.com/jp/cdk/faqs/)

### 1.2. å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹

ã€AWS Black Belt Online Seminarã€‘AWS CDK æ¦‚è¦ (Basic #1)[ | YouTube](https://youtu.be/BmCpa44rAXI)(0:33:07) | [PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-1-Overview_0731_v1.pdf)

![blackbelt-cdk-0](/images/blackbelt/blackbelt-cdk_1-320.jpg)

ã€AWS Black Belt Online Seminarã€‘AWS CDK ã®åŸºæœ¬çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨æ©Ÿèƒ½ (Basic #2) | [YouTube](https://youtu.be/aqa2bFFzcjs)(0:28:13) | [PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-2-Features_0831_v1.pdf)

![blackbelt-cdk-1](/images/blackbelt/blackbelt-cdk_2-320.jpg)

ã€AWS Black Belt Online Seminarã€‘AWS CDK ã®é–‹ç™ºã‚’åŠ¹ç‡åŒ–ã™ã‚‹æ©Ÿèƒ½ (Basic #3) | [YouTube](https://youtu.be/z3Mst77p-aU)(0:29:20) | [PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-3-AppDev_0831_v1.pdf)

![blackbelt-cdk-2](/images/blackbelt/blackbelt-cdk_3-320.jpg)

ã€AWS Black Belt Online Seminarã€‘AWS Cloud Development Kit (CDK) | [YouTube](https://youtu.be/1i7kWqpqtoY)(1:01:23)

![blackbelt-cdk-3](/images/blackbelt/blackbelt-cdk_4-320.jpg)

[åˆå¿ƒè€…ãŒãŠã•ãˆã¦ãŠããŸã„AWS CDKã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ 2024| Speaker Deck](https://speakerdeck.com/konokenj/cdk-best-practice-2024)

[AWS CDKã®ã‚ã‚‹ã‚ã‚‹ãŠæ‚©ã¿ã«ç­”ãˆãŸã„| Speaker Deck](https://speakerdeck.com/tmokmss/answering-cdk-faqs)

[AWS CDK ã«ãŠã‘ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½¿ã„æ‰€ã‚’å­¦ã¶|builders.flash](https://aws.amazon.com/jp/builders-flash/202411/learn-cdk-unit-test/)

[AWS CDK ã«ãŠã‘ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ã„åˆ†ã‘æ–¹ã‚’å­¦ã¶|builders.flash](https://aws.amazon.com/jp/builders-flash/202406/cdk-validation/)

[AWS CDK ã§ã‚¢ãƒ—ãƒªã¨ä¸€ç·’ã«ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§æ“ã‚ã† !|builders.flash](https://aws.amazon.com/jp/builders-flash/202411/operate-infrastructure-with-cdk/)

### 1.3. ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—

[AWS CDK Immersion Day Workshop](https://catalog.us-east-1.prod.workshops.aws/workshops/10141411-0192-4021-afa8-2436f3c66bd8/ja-JP)

[AWS CDK ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚’ä½œã‚ã†ï¼|builders.flash](https://aws.amazon.com/jp/builders-flash/202411/create-cdk-local-dev-environment/)

### 1.4. å°å…¥ã®ãƒ¡ãƒªãƒƒãƒˆ

AWS CDKã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å°å…¥ã™ã‚‹ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹ä¸»ãªãƒ¡ãƒªãƒƒãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

#### 1. å‹å®‰å…¨æ€§ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼æ¤œå‡º

TypeScriptã‚„Javaãªã©ã®é™çš„å‹ä»˜ãè¨€èªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€CloudFormationã§ã¯å®Ÿè¡Œæ™‚ã«ã—ã‹æ¤œå‡ºã§ããªã‹ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒŸã‚¹ã‚’ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ç™ºè¦‹ã§ãã¾ã™ã€‚
ã“ã‚Œã¯ã€å¤§è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã»ã©ã“ã®æ©æµã¯å¤§ãããªã‚Šã¾ã™ã€‚

```typescript
// With TypeScript, incorrectly typed parameters are caught during development
const bucket = new s3.Bucket(this, 'MyBucket', {
    versioned: true,
    // If you try to set an invalid property, TypeScript will flag it
    // invalidProperty: 'value' // This would cause a compilation error
});
```

#### 2. ã‚³ãƒ¼ãƒ‰å†åˆ©ç”¨ã«ã‚ˆã‚‹å“è³ªå‘ä¸Šã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›
ã‚«ã‚¹ã‚¿ãƒ Constructã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€çµ„ç¹”å†…ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’çµ„ã¿è¾¼ã‚“ã ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†åˆ©ç”¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã‚’å®Ÿç¾ã§ãã‚³ã‚¹ãƒˆå‰Šæ¸›ã¨å“è³ªå‘ä¸Šã«ã¤ãªãŒã‚Šã¾ã™ã€‚

- å€‹ã€…ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆã®ä¸€è²«æ€§ç¢ºä¿
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®æ¨™æº–åŒ–
- å¤‰æ›´ãŒå¿…è¦ã«ãªã£ãŸå ´åˆã®ä¸€å…ƒç®¡ç†


```typescript
export class SecureS3Bucket extends Construct {
    public readonly bucket: s3.IBucket;
    
    constructor(scope: Construct, id: string, props?: s3.BucketProps) {
        super(scope, id);
        
        // Apply organization's security standards
        this.bucket = new s3.Bucket(this, 'Bucket', {
            ...props,
            encryption: s3.BucketEncryption.S3_MANAGED,
            blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
            enforceSSL: true,
            versioned: true
        });
    }
}
```

#### 3. é–‹ç™ºç”Ÿç”£æ€§ã®å‘ä¸Š

AWS CDKã¯ä½¿ã„æ…£ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹è¨€èªã¯ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚è©³ã—ãã¯[AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/languages.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- TypeScript
- JavaScript
- Python
- Java
- C#
- Go

ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€CloudFormationã§ã¯é›£ã—ã‹ã£ãŸæ¬¡ã®ã‚ˆã†ãªé–‹ç™ºç”Ÿç”£æ€§ã®å‘ä¸Šã«ã¤ãªãŒã‚Šã¾ã™ã€‚

- ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚µãƒãƒ¼ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰è£œå®Œã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã‚’æ´»ç”¨ã§ãã‚‹
- æ¡ä»¶åˆ†å²ã€ãƒ«ãƒ¼ãƒ—ã€é–¢æ•°æŠ½è±¡åŒ–ãªã©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®æ‰‹æ³•ãŒä½¿ãˆã‚‹
- å˜ä½“ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆãªã©ã®æ—¢å­˜ãƒ†ã‚¹ãƒˆæ‰‹æ³•ãŒé©ç”¨ã§ãã‚‹

ç‰¹ã«ä¾¡å€¤ãŒé«˜ã„ã®ã¯ã€æ¡ä»¶åˆ†å²ã«ã‚ˆã£ã¦ç’°å¢ƒã«ã‚ˆã‚‹é•ã„ãªã©ã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ç‚¹ã§ã™ã€‚
ãŸã ã—ã€éåº¦ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã¸ã®ä¾å­˜ã¯è¤‡é›‘æ€§ã‚’é«˜ã‚ã€ä¿å®ˆæ€§ãŒä½ä¸‹ã—ã¾ã™ã€‚é©åº¦ãªåˆ©ç”¨ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚


```typescript
// Easily implement environment-specific configurations
const isProd:boolean = app.node.tryGetContext('environment') === 'prod';

const bucket = new s3.Bucket(this, 'DataBucket', {
    versioned: true,
    lifecycleRules: isProd ? [
        {
            expiration: Duration.days(365),
            transitions: [
                {
                    storageClass: s3.StorageClass.INFREQUENT_ACCESS,
                    transitionAfter: Duration.days(30)
                },
                {
                    storageClass: s3.StorageClass.GLACIER,
                    transitionAfter: Duration.days(90)
                }
            ]
        }
    ] : undefined
});
```

#### 4. ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®çµ±åˆ

AWS CDKã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰ã‚’åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã«ä¼´ã†ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã‚’åŒä¸€PRï¼ˆPull Request, ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã§ç®¡ç†
- ç’°å¢ƒå¤‰æ•°ã‚„IAMãƒãƒªã‚·ãƒ¼ãªã©ã®è¨­å®šãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¨å¸¸ã«åŒæœŸ
- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸€å…ƒåŒ–

#### 5. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¨ã‚¬ãƒãƒŠãƒ³ã‚¹ã®å¼·åŒ–

å¤§è¦æ¨¡ãªçµ„ç¹”ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã„ã¦ã€AWS CDKã¯ä»¥ä¸‹ã®åŠ¹æœã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚

- ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£æ‹¡å¤§: åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¤‡æ•°ç’°å¢ƒã‚„è¤‡æ•°ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ç´ æ—©ãå±•é–‹å¯èƒ½
- æ¨™æº–åŒ–: çµ„ç¹”ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å¼·åˆ¶
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’äº‹å‰ã«çµ„ã¿è¾¼ã‚“ã Constructã‚’æ´»ç”¨
- ç¶™ç¶šçš„æ”¹å–„: ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©ã®ç›£æŸ»ã‚„æ›´æ–°ãŒå¯èƒ½

### 1.5. CloudFormationã¨ã®é•ã„

AWSã«ã¯ã€IaCã‚’å®Ÿç¾ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã€AWS CDKã®ã»ã‹ã«CloudFormationãŒã‚ã‚Šã¾ã™ã€‚Black Beltã§ã¯æ¬¡ã®ã‚ˆã†ãªæ¯”è¼ƒãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

![cdk-cfn](/images/cdk/cdk-cfn.jpg)

AWS CDKã¯ã€Appã«ã‚ˆã£ã¦è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸€åº¦ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã®ã§ä½œæ¥­åŠ¹ç‡ãŒå‘ä¸Šã—ã¾ã™ã€‚

ã¾ãŸã€CloudFormationã¨AWS CDKã§ã¯ã‚³ãƒ¼ãƒ‰è¨˜è¿°é¢ã«ãŠã„ã¦ã€å¤§ããªé•ã„ãŒã‚ã‚Šã¾ã™ã€‚

CloudFormationã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

- JSONã‚„YAMLå½¢å¼ã®ã¿ã§è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã™ã¹ã¦ã®å®šç¾©ã‚’æ˜ç¤ºçš„ã«è¨˜è¿°ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
- æ§‹æˆã®è¤‡é›‘åº¦ã«æ¯”ä¾‹ã—ã¦ã€ã‚³ãƒ¼ãƒ‰è¨˜è¿°é‡ãŒå¢—å¤§ã™ã‚‹
- ã‚³ãƒ¼ãƒ‰é‡ã®å¢—å¤§ã«ä¼´ã„ã€å¯èª­æ€§ãŒä½ä¸‹ã™ã‚‹

ã“ã‚Œã«å¯¾ã—ã¦ã€AWS CDKã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- TypeScriptãªã©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªãŒåˆ©ç”¨å¯èƒ½
- IDEãªã©ã§ã‚³ãƒ¼ãƒ‰è£œå®ŒãŒåˆ©ç”¨å¯èƒ½
- CDKãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã‚‹è‡ªå‹•ç”ŸæˆãŒåˆ©ç”¨ã§ãã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰è¨˜è¿°é‡ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã‚‹
- ã‚³ãƒ¡ãƒ³ãƒˆã‚„IDEã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰é‡ãŒå¢—å¤§ã—ã¦ã‚‚å¯èª­æ€§ã¸ã®å½±éŸ¿ã¯é™å®šçš„

ä¾‹ãˆã°ã€ä¸‹å›³ã®ã‚ˆã†ãª2ã¤ã®AZã«ã‚µãƒ–ãƒãƒƒãƒˆã¨NATGateway1å°ã‚’å‚™ãˆãŸVPCã‚’æ§‹ç¯‰ã™ã‚‹å ´åˆã§ã€å„å®Ÿè£…æ–¹æ³•ã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![sample](/images/cdk/sample.png)

ã¾ãšã€JSONã§è¨˜è¿°ã—ãŸä¾‹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚æ‹¬å¼§ãªã©ã®æ§‹æ–‡ã®ç‰¹æ€§ä¸Šã€ã‚³ãƒ¼ãƒ‰ãŒéå¸¸ã«é•·ããªã‚Šã€äººé–“ãŒç›´æ„Ÿçš„ã«èª­ã¿è§£ãã®ã¯å®¹æ˜“ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

![sample-cfn-json](/images/cdk/sample-cfn-json.png)

æ¬¡ã«ã€YAMLã§è¨˜è¿°ã—ãŸä¾‹ã§ã™ã€‚JSONã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜å…¥ã§ããªã„ãŸã‚ã€å®Ÿå‹™ã§ã¯YAMLå½¢å¼ãŒå¤šãæ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚JSONå½¢å¼ã‚ˆã‚Šã¯éšå±¤æ§‹é€ ãŒè¦–è¦šçš„ã«ç†è§£ã—ã‚„ã™ããªã‚Šã¾ã™ãŒã€ãã‚Œã§ã‚‚è¨˜è¿°ã™ã‚‹ã‚³ãƒ¼ãƒ‰é‡ã¯å¤šãã€è¤‡é›‘ãªã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã§ã¯ç®¡ç†ãŒé›£ã—ããªã‚Šã¾ã™ã€‚

![sample-cfn-yaml](/images/cdk/sample-cfn-yaml.png)

æœ€å¾Œã«ã€AWS CDKã§TypeScriptã‚’ä½¿ã£ã¦å®Ÿè£…ã—ãŸä¾‹ã§ã™ã€‚å¾Œè¿°ã™ã‚‹L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã€é–‹ç™ºè€…ã¯æœ¬è³ªçš„ãªè¨­å®šã®ã¿ã«é›†ä¸­ã§ãã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®ã‚ˆã†ã«å°‘ãªã„ã‚³ãƒ¼ãƒ‰é‡ã§åŒç­‰ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã€å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

![sample-cdk-ts](/images/cdk/sample-cdk-ts.png)

### è£œè¶³ï¼šãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦

AWS CDKãŒå¤§å¹…ã«å‰Šæ¸›ã§ãã‚‹ã€Œãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã€ã¨ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ãŠã„ã¦ç¹°ã‚Šè¿”ã—è¨˜è¿°ã•ã‚Œã‚‹å®šå‹çš„ãªã‚³ãƒ¼ãƒ‰ã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚åå‰ã®ç”±æ¥ã¯ã€ã‹ã¤ã¦ã®æ–°èæ¥­ç•Œã§ä½•åº¦ã‚‚å†åˆ©ç”¨ã•ã‚ŒãŸé‡‘å±è£½ã®å°åˆ·ç‰ˆï¼ˆãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã‹ã‚‰æ¥ã¦ã„ã¾ã™ã€‚

CloudFormationã®JSONã‚„YAMLè¨˜è¿°ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼š

- ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã®å®Œå…¨ä¿®é£¾åã®è¨˜è¿°
- å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ˜ç¤ºçš„ãªå®£è¨€
- ãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢é€£ä»˜ã‘ã‚’ç¤ºã™å‚ç…§æ§‹æ–‡
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã‚ã£ã¦ã‚‚å¿…è¦ãªè¨­å®šé …ç›®ã®è¨˜è¿°
- ãƒªã‚½ãƒ¼ã‚¹å±æ€§ã‚„ã‚¿ã‚°ã®ç¹°ã‚Šè¿”ã—å®šç¾©

ä¸€æ–¹ã€AWS CDKã§ã¯ã€L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãªã©ã®é«˜ãƒ¬ãƒ™ãƒ«æŠ½è±¡åŒ–ã«ã‚ˆã‚Šã€ã“ã‚Œã‚‰ã®ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚é–‹ç™ºè€…ã¯æœ¬è³ªçš„ãªè¨­å®šï¼ˆVPCã®CIDRç¯„å›²ã‚„ã‚µãƒ–ãƒãƒƒãƒˆæ•°ãªã©ï¼‰ã®ã¿è¨˜è¿°ã™ã‚‹ã ã‘ã§ã€é–¢é€£ã™ã‚‹æ¨™æº–çš„ãªãƒªã‚½ãƒ¼ã‚¹ã‚„ãã®è¨­å®šã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã®å‰Šæ¸›ã¯ã€å˜ã«ã‚³ãƒ¼ãƒ‰é‡ã‚’æ¸›ã‚‰ã™ã ã‘ã§ãªãã€æ¬¡ã®ã‚ˆã†ãªåŠ¹æœã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚

- äººç‚ºçš„ãªã‚¨ãƒ©ãƒ¼ã®æ¸›å°‘
- ã‚³ãƒ¼ãƒ‰å…¨ä½“ã®å¯èª­æ€§å‘ä¸Š
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å·¥æ•°ã®å‰Šæ¸›
- æœ¬è³ªçš„ãªã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆã¸ã®é›†ä¸­

ã•ãã»ã©ç¤ºã—ãŸæ§‹æˆä¾‹ã§ã‚‚ã€AWS CDKã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ã§ã¯ã€VPCã¨ã‚µãƒ–ãƒãƒƒãƒˆã®æœ¬è³ªçš„ãªè¨­å®šã®ã¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã®ä»–ã®æ¨™æº–çš„ãªè¨­å®šã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰é‡ãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã¦ã„ã¾ã™ã€‚

## 2. AWS CDKã®åŸºç¤

### 2.1. AWS CDK ã®æ§‹æˆè¦ç´ 

é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰ã®æ§‹æˆå›³ã‹ã‚‰ã€ä¸»è¦æ§‹æˆè¦ç´ ã¯ä»¥ä¸‹ã®ï¼“ã¤ã§ã™ã€‚

- App
- Stack(s)
- Construct

![AppStacks.png](/images/cdk/AppStacks.png)

å¼•ç”¨ï¼š[é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰>CDK ã¨ã¯](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)

AWS CDKã‚’ä½¿ç”¨ã—ã¦AWSç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€æœ€çµ‚çš„ã«ã¯CloudFormationã®ã‚¹ã‚¿ãƒƒã‚¯ã¨ã—ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚

ã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã€CloudFormationã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/cloudformation-overview.html#cfn-concepts-stacks)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 2.1.1. App

AWS CDK ã®æœ€ä¸Šä½å±¤ã§ã€è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ä¾å­˜é–¢ä¿‚ãªã©ã‚’å®šç¾©ã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚è¤‡æ•°ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';

// Stackã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { Stack1 } from '../lib/stacks/stack1'
import { Stack2 } from '../lib/stacks/stack2'

const app = new cdk.App();

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³
const stack1 = new Stack1(app,'Stack1',{
  // ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®š
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  }
});

// æ˜ç¤ºçš„ã«æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
const stack2 = new Stack2(app,'Stack2',{
  // ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®š
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: "ap-northeast-1",
  }
});
stack2.addDependency(stack1); // ä¾å­˜é–¢ä¿‚

// ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
const stack3 = new Stack2(app,'Stack3',{
  // ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®š
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: "us-east-1",
  }
});
stack3.addDependency(stack1); // ä¾å­˜é–¢ä¿‚
```

#### 2.1.2. Stack(s)

CloudFormation ã®ã‚¹ã‚¿ãƒƒã‚¯ï¼‘ã¤ã«å¯¾å¿œã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚Appã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```ts
import { StackProps } from 'aws-cdk-lib';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import {
  aws_s3 as s3,
  aws_ec2 as ec2, 
  aws_iam as iam,
  aws_kms as kms,
} from 'aws-cdk-lib';

interface Stack1Props extends StackProps {
  readonly param1: string;
  readonly param2: string;
}

export class Stack1 extends cdk.Stack {
  constructor(scope: Construct, id: string, props: Stack1Props) {
    super(scope, id, props);

  }
}
``` 

#### 2.1.3. Construct

Stack å±¤ã« AWS ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã‚’ä½œæˆã—ã¾ã™ã€‚

Construct ã«ã¯ 3 ã¤ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚L1â†’L3ã®é †ã§æŠ½è±¡åŒ–ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚Šã¾ã™ã€‚

- L1 Construct(Low Level Construct)
- L2 Construct(High Level Construct)
- L3 Construct(Patterns)

![cdk-construct](/images/cdk/cdk-construct.jpg)

å¼•ç”¨ï¼šã€AWS Black Belt Online Seminarã€‘[AWS CDK æ¦‚è¦ (Basic #1)(YouTube)](https://youtu.be/BmCpa44rAXI)

##### L1 Construct

L1 Construct ã¨ã¯ã€Low Level Construct ã®ã“ã¨ã§ã™ã€‚CloudFormation ã®å„ãƒªã‚½ãƒ¼ã‚¹ã¨ 1:1 ã®é–¢ä¿‚ã«ãªã£ã¦ã„ã¾ã™ã€‚`Cfn`ã§å§‹ã¾ã‚‹ã‚‚ã®ãŒ L1 ã§ã™ã€‚

CloudFormation ã§å®šç¾©ã™ã‚‹ã®ã¨åŒã˜ãƒ¬ãƒ™ãƒ«ã§ã®è¨˜è¼‰ã«ãªã‚Šã¾ã™ã€‚**L2 Construct ãŒå­˜åœ¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ã€L2 Construct ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨**ã—ã¾ã™ãŒã€è¦ä»¶ã«å¿œã˜ãŸç´°ã‹ã„è¨­å®šãŒå¿…è¦ãªå ´åˆã¯ã€L1 Construct ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```ts
const bucket = new s3.CfnBucket(this, "MyBucket", {
  bucketName: "MyBucket",
});
```

##### L2 Construct

L2 Construct ã¨ã¯ã€High Level Construct ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€L1 Construct ã‚’ãƒ©ãƒƒãƒ—ã—ãŸ Construct ã§ã™ã€‚
AWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã«å¿…è¦ãªè¦ç´ ãŒæœªæŒ‡å®šã ã£ãŸå ´åˆã«è‡ªå‹•çš„ã«ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã®ãŒæœ€å¤§ã®ãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€è¨˜è¿°ã™ã‚‹ã‚³ãƒ¼ãƒ‰é‡ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

L1 Constructã§S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹å ´åˆã€ãƒã‚±ãƒƒãƒˆåã¯å¿…é ˆã§ã™ãŒã€L2 Constructã§ã¯æœªæŒ‡å®šã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ãƒã‚±ãƒƒãƒˆåã™ã‚‰çœç•¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```ts
import * as s3 from "aws-cdk-lib/aws-s3";

const bucket = new s3.Bucket(this, "MyBucket", {
  versioned: true,
});
```

##### L3 Construct

L3 Construct ã¨ã—ã¦ã€ECS Patterns ã®ã‚ˆã†ã« ECS é–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç°¡å˜ã«ç”Ÿæˆã§ãã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã ã‘ã§ã€ECS ã‚µãƒ¼ãƒ“ã‚¹ã€ALBã€é–¢é€£ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚¿ã‚¹ã‚¯ç”¨ã® IAM ãƒ­ãƒ¼ãƒ«ãªã© 200 ï½ 300 è¡Œã® CloudFormation ã®ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚
è¦ä»¶ãŒåˆè‡´ã™ã‚Œã°éå¸¸ã«ç°¡å˜ã«ç’°å¢ƒæ§‹ç¯‰ãŒè¡Œãˆã¾ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒè¡Œã„ã«ãã„ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚å…¬å¼ã§æä¾›ã•ã‚Œã¦ã„ã‚‹L3 Constructã‚‚æ•°ãŒå°‘ãªã„ã“ã¨ã‹ã‚‰ã€åŸºæœ¬çš„ã«ã¯L2 Constructã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```ts
// ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆ
const cluster = new ecs.Cluster(this, "MyCluster", {
  vpc: props.vpc,
});

const loadBalancedFargateService =
  new ecs_patterns.ApplicationLoadBalancedFargateService(
    this,
    "MyFargateService",
    {
      cluster: cluster,
      cpu: 4096,
      memoryLimitMiB: 30720,
      publicLoadBalancer: true,
      desiredCount: 6,
      taskImageOptions: {
        image: ecs.ContainerImage.fromRegistry("amazon/amazon-ecs-sample"),
      },
    }
  );
```

### 2.2. AWS CDK ã®ã‚³ãƒãƒ³ãƒ‰

AWS CDKã§ä½¿ç”¨ã™ã‚‹ä¸»ãªã‚³ãƒãƒ³ãƒ‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
ã“ã“ã§èª¬æ˜ã—ã¦ã„ãªã„ã‚³ãƒãƒ³ãƒ‰ãªã©ã€è©³ç´°ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/ref-cli-cmd.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 2.2.1. [cdk init](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/ref-cli-cmd-init.html)

AWS CDKã§ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹å‰ã«ã€å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã€å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
languageã«ã¯ã€[csharp|fsharp|go|java|javascript|python|typescript]ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€TypeScriptã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ä¾‹ã§ã™ã€‚

```sh
cdk init app --language typescript
```

#### 2.2.2. [cdk bootstrap](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/ref-cli-cmd-bootstrap.html)

AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§åˆã‚ã¦AWS CDKã‚’åˆ©ç”¨ã™ã‚‹éš›ã«å®Ÿè¡Œã—ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«`CDKToolkit`ã¨ã„ã†CloudFormationã®ã‚¹ã‚¿ãƒƒã‚¯ãŒä½œæˆã•ã‚Œã€AWS CDKã‚’åˆ©ç”¨ã™ã‚‹ã®ã«å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```sh
cdk bootstrap
```

ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯è¨˜äº‹ä½œæˆæ™‚ç‚¹ã§ã¯ã€ä¸‹è¨˜11ç¨®é¡ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- CdkBootstrapVersionï¼šBootStrapã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹SSMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã§ã™ã€‚å®šæœŸçš„ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹ãŸã‚ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
- DeploymentActionRoleï¼šãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«CloudFormatioã‚¹ã‚¿ãƒƒã‚¯ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã§ã™
- CloudFormationExecutionRoleï¼š`AdministratorAccess`ãŒä»˜ä¸ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã§ã€`cdk deploy`ã§ä½œæˆã•ã‚Œã‚‹ã‚¹ã‚¿ãƒƒã‚¯å®Ÿè¡Œæ™‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- LookupRoleï¼šæ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã™ã‚‹`fromLookup()`ãªã©ã®å®Ÿè¡Œã«å¿…è¦ãªãƒ­ãƒ¼ãƒ«ã§ã™
- ContainerAssetsRepositoryï¼šECRãƒªãƒã‚¸ãƒˆãƒªã§ã™
- ImagePublishingRoleï¼šECRãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã§ã™
- ImagePublishingRoleDefaultPolicyï¼šä¸Šè¨˜IAMãƒ­ãƒ¼ãƒ«ã®ãƒãƒªã‚·ãƒ¼ã§ã™
- StagingBucketï¼š`cdk deploy`æ™‚ã«CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚„Lambdaã‚½ãƒ¼ã‚¹ã®zipãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®S3ãƒã‚±ãƒƒãƒˆã§ã™
- StagingBucketPolicyï¼šä¸Šè¨˜ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã§ã™
- FilePublishingRoleï¼šS3ãƒã‚±ãƒƒãƒˆã«ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã§ã™
- FilePublishingRoleDefaultPolicyï¼šä¸Šè¨˜IAMãƒ­ãƒ¼ãƒ«ã®ãƒãƒªã‚·ãƒ¼ã§ã™

#### 2.2.3. [cdk deploy](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-deploy)

AWS CDK ã§å®šç¾©ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ AWS ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ã€`--all` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```sh
cdk deploy --all
```

æŒ‡å®šã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ã€deploy ã®å¾Œã«ã‚¹ã‚¿ãƒƒã‚¯åã‚’æŒ‡å®šã—ã¾ã™ã€‚

```sh
cdk deploy Stack1 Stack2
```

#### 2.2.4. [cdk diff](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-diff)

ç¾åœ¨ã® AWS CDK ã¨ã™ã§ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å¤‰æ›´ç‚¹ã‚’ä¸€è¦§ã§å–å¾—ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
`deploy`ã¨åŒã˜ã‚ˆã†ã«ã€ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯`--all`ã€ç‰¹å®šã®ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯ã‚¹ã‚¿ãƒƒã‚¯åã‚’æŒ‡å®šã—ã¾ã™ã€‚

```sh
cdk diff --all
or
cdk diff  Stack1 Stack2
```

#### 2.2.5. [cdk synth](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-synth)

AWS CDK ã§å®šç¾©ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹ã«ä»˜ä¸ã•ã‚Œã‚‹ Metadata ã‚’å‰Šé™¤ã—ãŸã„å ´åˆã¯ã€`--path-metadata false` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å‡ºåŠ›ã›ãšã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã«è¨˜è¿°ã—ãŸ console.log() ã ã‘ç¢ºèªã—ãŸã„å ´åˆã¯ã€ `--quit` ã¾ãŸã¯ `-q` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```sh
cdk synth
or
cdk synth --version-reporting false --path-metadata false --asset-metadata false
or
cdk synth -q
```

#### 2.2.6. [cdk destroy](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/ref-cli-cmd-destroy.html)

ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã«åˆ©ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
`deploy`ã¨åŒã˜ã‚ˆã†ã«ã€ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯`--all`ã€ç‰¹å®šã®ã‚¹ã‚¿ãƒƒã‚¯ã®å ´åˆã¯ã‚¹ã‚¿ãƒƒã‚¯åã‚’æŒ‡å®šã—ã¾ã™ã€‚
ä¾å­˜é–¢ä¿‚ã®ã‚¨ãƒ©ãƒ¼ãªã©ã‚’ç„¡è¦–ã—ã¦å¼·åˆ¶çš„ã«å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€`--force`ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```sh
cdk destroy --all
or
cdk destroy  Stack1 Stack2
```

#### 2.2.7. [cdk list / cdk ls](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-list)

ç¾åœ¨ã® AWS CDK ã‚¢ãƒ—ãƒªã«å«ã¾ã‚Œã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

```sh
cdk list
or
cdk ls
```

### 2.3. CDKã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

#### 2.3.1. CDK v2

![cdk-v2](/images/cdk/cdk-v2.jpg)

ç¾åœ¨ã®AWS CDKã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€`v2`ã¨ãªã£ã¦ã„ã¾ã™ã€‚v2ã¯ã€2021å¹´5æœˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Ÿæ–½ã•ã‚Œã€2021å¹´12æœˆ2æ—¥ã«GAã•ã‚Œã¾ã—ãŸã€‚

AWS Cloud Development Kit v2 é–‹ç™ºè€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãŠçŸ¥ã‚‰ã›
https://aws.amazon.com/jp/blogs/news/announcing-aws-cloud-development-kit-v2-developer-preview/

AWS Cloud Development Kit (AWS CDK) v2 ã®ä¸€èˆ¬æä¾›é–‹å§‹
https://aws.amazon.com/jp/about-aws/whats-new/2021/12/aws-cloud-development-kit-cdk-generally-available/

v2sã§ã¯Constructãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ`aws-cdk-lib`ã«å˜ä¸€åŒ–ã•ã‚ŒãŸãŸã‚ã€v1ã§å®Ÿæ–½ã—ã¦ã„ãŸå€‹ã€…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚

v1ã§ã¯å€‹åˆ¥ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸãŸã‚ã€å¾Œã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãªã„ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã‚‹ãŸã‚ã«ã€ã€Œnpm install @aws-cdk/aws-lambda@1.111.0ã€ã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

```ts
npm install @aws-cdk/aws-lambda
npm install @aws-cdk/aws-cloudfront
npm install @aws-cdk/aws-iam
npm install @aws-cdk/aws-s3

import * as cdk from "@aws-cdk/core";
import * as cloudfront from "@aws-cdk/aws-cloudfront";
import * as s3 from "@aws-cdk/aws-s3";
import * as iam from "@aws-cdk/aws-iam";
```

v2 ã§ã¯å˜ä¸€ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«çµ±åˆã•ã‚ŒãŸãŸã‚ã€å€‹åˆ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãªãä½¿ç”¨ã§ãã¾ã™ã€‚

```ts
npm install aws-cdk-lib

import {
  aws_s3 as s3,
  aws_iam as iam,
  aws_cloudfront as cloudfront,
from "aws-cdk-lib";
```

#### 2.3.2.ï¼ˆ2025/2/3è¿½è¨˜ï¼‰AWS CDK ã¯ AWS CDK CLI ã¨ CDK ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ†é›¢

[AWS CDK ã¯ AWS CDK CLI ã¨ CDK ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ†é›¢ã—ã¾ã™](https://aws.amazon.com/jp/blogs/news/aws-cdk-is-splitting-construct-library-and-cli/)

AWS CDK CLI ã¨ CDK ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ†é›¢ã§ä»¥ä¸‹ã®å½±éŸ¿ãŒã‚ã‚Šã¾ã™ï¼š

1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ä¸ä¸€è‡´: aws-cdkã¨aws-cdk-libã§ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä½“ç³»ã«
  - `aws-cdk`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ`2.174.0`ã®æ¬¡ã‹ã‚‰ã€`2.1000.0`ã«ãªã‚Šã¾ã™ã€‚
2. ä¾å­˜é–¢ä¿‚ç®¡ç†ã®å¤‰æ›´: package.jsonã§ã®æŒ‡å®šæ–¹æ³•ãŒå¤‰æ›´

å…·ä½“çš„ãªå¯¾å¿œæ–¹æ³•ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«package.jsonã‚’æ›´æ–°ã—ã¾ã™ï¼š

ä»¥å‰ã®æŒ‡å®šæ–¹æ³•ï¼š

```json
  "devDependencies": {
    "aws-cdk": "2.174.0",
    :
  },
  "dependencies": {
    "aws-cdk-lib": "2.174.0",
    :
  }
```

ã“ã‚Œã‹ã‚‰ã®æŒ‡å®šæ–¹æ³•ï¼š

```json
  "devDependencies": {
    "aws-cdk": "2.1000.0", // CLIã¯2.1000.0ã‹ã‚‰å§‹ã¾ã‚‹æ–°ã—ã„ä½“ç³»
    :
  },
  "dependencies": {
    "aws-cdk-lib": "2.180.0",  // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯å¾“æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½“ç³»ã‚’ç¶™ç¶š
    :
  }
```

ã“ã®åˆ†é›¢ã«ã‚ˆã‚‹å½±éŸ¿ã‚’æœ€å°åŒ–ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ¨å¥¨ã—ã¾ã™ï¼š

1. CI/CDç’°å¢ƒã§ã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å›ºå®šã™ã‚‹
2. ä¾å­˜é–¢ä¿‚ã‚’æ­£ç¢ºã«ç®¡ç†ã™ã‚‹
3. peerDependenciesã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ç®¡ç†ã™ã‚‹

## 3. AWS CDK ã§ã®é–‹ç™ºæ–¹æ³•

![cdk-dev-flow](/images/cdk/cdk-dev-flow.jpg)

AWS CDKã§é–‹ç™ºã™ã‚‹é †åºã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§`cdk init`ã‚’å®Ÿè¡Œ
- appå®šç¾©ã‚’ç·¨é›†
- stackå®šç¾©ã‚’ä½œæˆ
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
- åˆå›ï¼š
  - `cdk bootstrap`ã‚’å®Ÿè¡Œ
  - `cdk deploy`ã‚’å®Ÿè¡Œ
- 2å›ç›®ä»¥é™ï¼š
  - ï¼ˆä»»æ„ï¼‰`cdk diff`ã‚’å®Ÿè¡Œã—ã¦å·®åˆ†ãƒã‚§ãƒƒã‚¯
  - `cdk deploy`ã‚’å®Ÿè¡Œï¼ˆã“ã“ã§ã‚‚å·®åˆ†ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ï¼‰

### 3.1. AWS CDKé–‹ç™ºã«å¿…è¦ãªã‚‚ã®

#### 3.1.1. çŸ¥è­˜

çŸ¥è­˜ã¨ã—ã¦ã‚ã£ãŸã»ã†ãŒã„ã„ã‚‚ã®ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- AWSãƒªã‚½ãƒ¼ã‚¹å…¨èˆ¬ã«å¯¾ã™ã‚‹åŸºç¤çŸ¥è­˜ã€‚èªå®šè©¦é¨“ã€Œ[AWS Certified Solutions Architect - Associate](https://aws.amazon.com/jp/certification/certified-solutions-architect-associate/)ã€ä»¥ä¸ŠãŒæœ›ã¾ã—ã„
- CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ãŸç’°å¢ƒæ§‹ç¯‰çµŒé¨“
- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°é–‹ç™ºçµŒé¨“

#### 3.1.2. ç’°å¢ƒ

æœ€ä½é™å¿…è¦ãªã‚‚ã®ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- AWS CLI v2
- Node.js
- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿

ã§ãã‚Œã°ç”¨æ„ã—ãŸã»ã†ãŒã„ã„ã‚‚ã®ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- Git
- IDE
  - ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚ˆã‚Šã€VS Codeãªã©ã®IDEã‚’ä½¿ã†ã»ã†ãŒé–‹ç™ºç”Ÿç”£æ€§ãŒå‘ä¸Šã—ã¾ã™

### 3.2. å€‹äººçš„AWS CDKã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

`cdk init --typescript` ã‚’å®Ÿè¡Œã™ã‚‹ã¨åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™ã€‚
é€šå¸¸ã¯ã€[lib] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¹ã‚¿ãƒƒã‚¯ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚

ã—ã‹ã—ã€å…±é€šã§åˆ©ç”¨ã—ãŸã„ã‚‚ã®ãªã©ãŒå‡ºã¦ããŸã¨ãã«åˆ†ã‹ã‚Šã«ãããªã‚Šã¾ã™ã€‚

ãã“ã§ã€å€‹äººçš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¯ã“ã®ã‚ˆã†ã ã¨è€ƒãˆã¾ã™ã€‚'â˜…' ãŒä»˜ã„ã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯æ¨™æº–ä½œæˆä»¥å¤–ã§è¿½åŠ ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- ç’°å¢ƒã”ã¨ã®å‹•çš„è¨­å®šã‚’`cdk.json`ã§ã¯ãªãã€`parameters`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ç®¡ç†
- ã‚¹ã‚¿ãƒƒã‚¯å®šç¾©ã‚’æ˜ç¤ºçš„ã«ã€`stacks`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
- å…±é€šåˆ©ç”¨ã‚„ã€ã‚¹ã‚¿ãƒƒã‚¯å®šç¾©ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚‚ã®ã‚’`utils`ã‚„`resources`ã«åˆ†é›¢
- Lambdaãªã©ã®ã‚½ãƒ¼ã‚¹ã‚’`src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®

```text
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    â”œâ”€ [bin]                   // Appå®šç¾©ã€‚è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ä¾å­˜é–¢ä¿‚ãªã©ã‚’å®šç¾©
    â”œâ”€ [lib]
        â”œâ”€ â˜…[stacks]           // ã‚¹ã‚¿ãƒƒã‚¯å®šç¾©
        â”œâ”€ â˜…[resources]        // å„ãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã®å®šç¾©ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
        â”œâ”€ â˜…[utils]            // å…±é€šä½¿ç”¨ã™ã‚‹ã‚‚ã®ã‚’æ ¼ç´
    â”œâ”€ â˜…[parameters]           // ç’°å¢ƒä¾å­˜æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ï¼ˆâ€»contextã‚’ä½¿ã‚ãªã„ï¼‰
    â”œâ”€ â˜…[src]                  // Lambda ã‚„ HTML ãªã©ã®ã‚½ãƒ¼ã‚¹ã‚’æ ¼ç´
    â”œâ”€ [test]                  // ãƒ†ã‚¹ãƒˆ
        â”œâ”€ xxxxx.test.ts           // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
        â”œâ”€ xxxxx-cdk-nag.test.ts   // CDK-NAG
        â”œâ”€ xxxxx-unittest.test.ts  // Unit Test
    â”œâ”€ [node_modules]
    â”œâ”€ cdk.context.json        // ç’°å¢ƒä¾å­˜æƒ…å ±(context)
    â”œâ”€ cdk.json                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®appãªã©ãŒå…¥ã‚‹
    â”œâ”€ cdk.out                 // cfnãªã©ã®å‡ºåŠ›å…ˆã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸjsã‚’å‹•ã‹ã™ã¨å‡ºåŠ›ã•ã‚Œã‚‹
    â”œâ”€ jest.config.js          // ãƒ†ã‚¹ãƒˆã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€ package-lock.json
    â”œâ”€ package.json
    â”œâ”€ tsconfig.json
    â”œâ”€ README.md
```

### 3.3. ã‚¹ã‚¿ãƒƒã‚¯ã®åˆ†å‰²æ–¹æ³•

ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒç•°ãªã‚‹ã€ãªã©ã®ç†ç”±ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
åˆ†å‰²ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ãŒäº’ã„ã«ä¾å­˜ã—ã¦ã„ãªã„å ´åˆã¯ã€ç©æ¥µçš„ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã«ãªã‚“ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¹ã‚¿ãƒƒã‚¯é–“ã§ãƒªã‚½ãƒ¼ã‚¹ã®å‚ç…§ãŒç™ºç”Ÿã™ã‚‹å ´åˆã«ã¯ã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ä¾å­˜ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã‚’æœ€å°é™ã«ã¨ã©ã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

AWS CDKã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹åˆ¥ãªç†ç”±ã‚’é™¤ãã€**å˜ä¸€ã®ã‚¹ã‚¿ãƒƒã‚¯ã§æ§‹ç¯‰ã™ã‚‹**ã®ãŒã‚ˆã„ã¨è€ƒãˆã¾ã™ã€‚

- å½±éŸ¿ç¯„å›²ã‚’åˆ†é›¢ã—ãŸã„
  - ä¾‹ï¼šã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆç›£æŸ»ãƒ­ã‚°ãªã©ã®åˆ©ç”¨ï¼‰ã ã‘ã¯æ®‹ã™å¯èƒ½æ€§ãŒã‚ã‚‹
- ï¼‘ã¤ã®ã‚¹ã‚¿ãƒƒã‚¯ã§ç®¡ç†ã§ãã‚‹åˆ¶é™ã‚’è¶…ãˆã‚‹
  - å‚ç…§ï¼š[CloudFormationã®ã‚¯ã‚ªãƒ¼ã‚¿](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/cloudformation-limits.html)

#### 3.3.1. ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã§å›°ã‚‹ã“ã¨

ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã§å›°ã‚‹ã“ã¨ã®ï¼‘ã¤ã«ã‚¹ã‚¿ãƒƒã‚¯é–“ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚
ã“ã®ã‚¹ã‚¿ãƒƒã‚¯é–“ã®å‚ç…§ã®ã“ã¨ã‚’ã€Œ[ã‚¯ãƒ­ã‚¹ã‚¹ã‚¿ãƒƒã‚¯å‚ç…§](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html)ã€ã¨ã„ã„ã€CloudFormationã§ã‚‚åˆ©ç”¨å¯èƒ½ã§å¤§å¤‰ä¾¿åˆ©ãªæ©Ÿèƒ½ã§ã™ã€‚

ã—ã‹ã—ã€å‚ç…§å…ƒï¼ˆè¦ªï¼‰ã¨å‚ç…§å…ˆï¼ˆå­ï¼‰ã®ä¾å­˜é–¢ä¿‚ã‚’å¼·ã‚ã¦ã—ã¾ã„ã€è¦ªå´ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã‚„å‰Šé™¤ã‚’ã—ãŸãã§ã‚‚ã€å­å´ã§å‚ç…§ã—ã¦ã„ã‚‹ã¨æ›´æ–°ã‚„å‰Šé™¤ã‚’å®Ÿæ–½ã§ããªã„ã€‚ã¨ã„ã£ãŸã“ã¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã“ã®ã‚ˆã†ãªã€Œãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã€çŠ¶æ…‹ã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã™ãŒã€é‹ç”¨ãŒè¤‡é›‘åŒ–ã—ã¾ã™ã€‚
ã“ã®ãƒªã‚¹ã‚¯ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã¯æ…é‡ã«æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã€Œ[CDK tips, part 3 â€“ how to unblock cross-stack references](https://www.endoflineblog.com/cdk-tips-03-how-to-unblock-cross-stack-references)ã€ã¨ã„ã†è¨˜äº‹ã«å…·ä½“çš„ãªæ–¹æ³•ãŒè§£èª¬ã•ã‚Œã¦ã„ã¾ã™ãŒã€è¤‡é›‘ãªæ‰‹é †ã§ã™ã€‚

ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

[å‚è€ƒï¼šAWS CloudFormationãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰>ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨æ‰€æœ‰æ¨©ã«ã‚ˆã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã®æ•´ç†](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/best-practices.html#organizingstacks)

### 3.4. Construct ID ã®å‘½åè¦å‰‡

Construct ID ã¨ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç¬¬äºŒå¼•æ•°ã§æŒ‡å®šã™ã‚‹æ–‡å­—åˆ—ã®ã“ã¨ã‚’ã„ã„ã¾ã™ã€‚ã“ã®æ–‡å­—åˆ—ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ä¸€æ„ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts
export class Stack1 extends cdk.Stack {
  constructor(scope: Construct, id: string, props: Stack1Props) {
    super(scope, id, props);

    const bucket1 = new s3.Bucket(this, "MyBucket", {});
    // bucket2ã§æŒ‡å®šã—ãŸ"MyBucket"ã¯ã™ã§ã«ä½¿ç”¨æ¸ˆã¿ãªã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
    const bucket2 = new s3.Bucket(this, "MyBucket", {});

  }
}
```

âš Construct ID ã¯ã€CloudFormationã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¤‰æ›å¾Œã®[è«–ç†IDï¼ˆè«–ç†åï¼‰](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/resources-section-structure.html#resources-section-logical-id)ã®ä¸€éƒ¨ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

#### ãƒ«ãƒ¼ãƒ«â‘ ï¼šConstruct IDã¯`PascalCase`ã‚’æ¨å¥¨ã™ã‚‹

ã¾ãšã€AWS CDKãŒè«–ç†IDã‚’ç”Ÿæˆã™ã‚‹éç¨‹ã§ã€`[A-Za-z0-9]`ä»¥å¤–é™¤å»ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€æŒ‡å®šã—ã¦ã‚‚ç„¡é§„ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

å‚è€ƒï¼š [aws-cdk/packages/aws-cdk-lib/core/lib/private/uniqueid.ts >removeNonAlphanumeric](https://github.com/aws/aws-cdk/blob/4b00ffeb86b3ebb9a0190c2842bd36ebb4043f52/packages/aws-cdk-lib/core/lib/private/uniqueid.ts#L86)

å®Ÿéš›ã¯ã€`PascalCase`ã§ãªãã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€AWS CloudFormationã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯è«–ç†IDãŒ`PascalCase`ã§è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã®ã§åˆã‚ã›ã‚‹ã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

#### ãƒ«ãƒ¼ãƒ«â‘¡ï¼šConstruct IDã¯`ã‚·ãƒ³ãƒ—ãƒ«ãªåç§°`ã¨ã™ã‚‹

é•·ã™ãã‚‹ã¨ç†è§£ã—ã«ãããªã‚Šã¾ã™ã®ã§ã€ã§ãã‚‹ã ã‘ã‚·ãƒ³ãƒ—ãƒ«ãªåç§°ã«ã™ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã™ã€‚
ã¾ãŸã€AWS CDKã§ã¯240æ–‡å­—ã§åˆ‡ã‚Šæ¨ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã®ã§ã€CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãªã£ãŸã¨ãã«æ„å‘³ãŒæ¬ è½ã—ã¾ã™ã€‚

å‚è€ƒï¼š [aws-cdk/packages/aws-cdk-lib/core/lib/private/uniqueid.ts >makeUniqueId](https://github.com/aws/aws-cdk/blob/4b00ffeb86b3ebb9a0190c2842bd36ebb4043f52/packages/aws-cdk-lib/core/lib/private/uniqueid.ts#L32)

#### ãƒ«ãƒ¼ãƒ«â‘¢ï¼šåˆ¥ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™å ´åˆã€`åŒã˜æ„å‘³`ã®Construct IDã‚’ä»˜ä¸ã—ãªã„

![construct-tree](/images/cdk/construct-tree.jpg)

å˜ä¸€ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å‡¦ç†ãŒå®Œçµã›ãšã€å…±é€šå®šç¾©ã•ã‚ŒãŸåˆ¥ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ãªå ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
Construct IDã¯è¦ªï¼‹å­ã¨ã„ã†ã‚ˆã†ã«é€£çµã•ã‚Œã¦ã„ãã¾ã™ã€‚

ä¾‹ãˆã°ã“ã®ã‚ˆã†ãªå‘¼ã³å‡ºã—ã‚’è¡Œã£ã¦ã„ãŸå ´åˆã§ã™ã€‚

å‘¼ã³å‡ºã—å…ƒã§æŒ‡å®šã—ãŸConstruct IDã€ŒMyBucketã€ï¼‹å‘¼ã³å‡ºã—å…ˆã§æŒ‡å®šã—ãŸConstruct IDã€ŒS3Bucketã€ãŒé€£çµã•ã‚Œã¦ã€ã€ŒMyBucketS3Bucket9C4D8843ã€ã¨ã„ã†è«–ç†IDãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ã€ŒBucketã€éƒ¨åˆ†ãŒé‡è¤‡ã—ã¦ã€å¯èª­æ€§ãŒä½ä¸‹ã—ã¾ã™ã€‚

```ts
import { BucketConstruct } from '../lib/bucket';

export class Stack1 extends cdk.Stack {
  constructor(scope: Construct, id: string, props: Stack1Props) {
    super(scope, id, props);

    const myBucket = new BucketConstruct(this,'MyBucket',{
      :
    });
  }
}

// å‘¼ã³å‡ºã—å…ˆ
export class BucketConstruct extends Construct {
  public readonly bucket: s3.IBucket;
  constructor(scope: Construct, id: string, props: S3BucketProps) {
    this.bucket =  new s3.Bucket(this, 'S3Bucket', {
      :
    }
  }
}
```

### 3.x. Construct ID ã«é–¢ã™ã‚‹ä½™è«‡

#### 3.x.1. Construct ID ã‹ã‚‰è«–ç†IDã«ã©ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã‹ï¼Ÿ

Construct IDã¨è«–ç†IDã¯å®Œå…¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã§ã¯ãªãã€Construct IDã‹ã‚‰è«–ç†IDã«å¤‰æ›ã•ã‚Œã‚‹ã¨ãƒãƒƒã‚·ãƒ¥å€¤ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ãŸå ´åˆã«ã¯ã€è«–ç†IDãŒã€ŒLogsBucket9C4D8843ã€ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```ts
const logBucket = new s3.Bucket(this, 'LogsBucket', {});
```

```json
"Resources": {
  "LogsBucket9C4D8843": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    :
   }
  }
}
```

Construct IDã‹ã‚‰è«–ç†IDã¸ã®å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ãŒæ°—ã«ãªã‚‹äººã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

[aws-cdk/packages/aws-cdk-lib/core/lib/stack.ts > allocateLogicalId](https://github.com/aws/aws-cdk/blob/4b00ffeb86b3ebb9a0190c2842bd36ebb4043f52/packages/aws-cdk-lib/core/lib/stack.ts#L1357)

![Stack.allocateLogicalId](/images/cdk/stack-allocateLogicalId.jpg)

## 4. AWS CDK ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•

ã“ã“ã§ã¯ã€AWS CDKã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

- Snapshot test
- Unit Test(Fine-grained Assertions)

### 4.1. Snapshot test

å‰å›ç”Ÿæˆã•ã‚ŒãŸ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨æ¯”è¼ƒã—ã¦å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹[ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/testing.html#testing_snapshot)ãŒå®Ÿæ–½ã§ãã¾ã™ã€‚
ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã§ã€æ„å›³ã—ãªã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¸ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œçŸ¥ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§åŠ¹æœã‚’ç™ºæ®ã—ã¾ã™ï¼š

- AWS CDKã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚‹å·®åˆ†ãƒã‚§ãƒƒã‚¯
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰å¾Œã®å·®åˆ†ãƒã‚§ãƒƒã‚¯

å…·ä½“çš„ãªã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è¨˜è¿°æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```ts
test('snapshot validation test',() =>{
    const stack = new MyTestStack(app, 'MyTest', {
        pjName: projectName,
        envName: envName,
        description: 'xxxxxxxx',
        :
        isAutoDeleteObject: false,
        env: defaultEnv,
        terminationProtection: false, // Enabling deletion protection
    });
    // add tag
    cdk.Tags.of(app).add('Project', projectName);
    cdk.Tags.of(app).add('Environment', envName);
    // test with snapshot
    expect(Template.fromStack(stack)).toMatchSnapshot();

})
```

### 4.2. Unit Test(Fine-grained Assertions)

Jest ã‚’ä½¿ã£ãŸ Unit Test ã‚‚å®Ÿæ–½ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚½ãƒ¼ã‚¹å˜ä½ã®ç´°ã‹ãªãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
VPC ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ VPC ã‚„ã‚µãƒ–ãƒãƒƒãƒˆã®æ•°ã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ãªã©ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãŸã ã€"AWS::EC2::VPC" ã®ã‚ˆã†ã« AWS ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’çŸ¥ã£ã¦ã„ãªã„ã¨ã„ã‘ãªã„ã®ã§æ…£ã‚Œãªã„ã†ã¡ã¯æ‰‹é–“å–ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

å…·ä½“çš„ãªè¨˜è¿°æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```ts
test("create the vpc", () => {
  // GIVEN
  const app = new App({
    context: {
      PJName: "junit",
      EnvName: "prod",
      CidrBlock: "10.0.0.0/16",
    },
  });
  const stack = new VPCStack(app, "testing-vpc", {});
  // WHEN
  const template = Template.fromStack(stack);

  // THEN
  // ã“ã‚Œä»¥é™ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ã€‚
  // VPC
  template.resourceCountIs("AWS::EC2::VPC", 1);
  template.hasResourceProperties("AWS::EC2::VPC", {
    CidrBlock: "10.0.0.0/16",
  });
  :
```

##### è¨˜è¿°ä¾‹â‘ ï¼šå˜ç´”ãªãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯

```ts
  // Subnet
  template.resourceCountIs("AWS::EC2::Subnet", 6);
  // Internet Gateway
  template.resourceCountIs("AWS::EC2::InternetGateway", 1);
  template.resourceCountIs("AWS::EC2::VPCGatewayAttachment", 1);
```

##### è¨˜è¿°ä¾‹â‘¡ï¼šå±æ€§å€¤ã®ãƒã‚§ãƒƒã‚¯

```ts
  // VPCGatewayAttachment
  template.hasResourceProperties("AWS::EC2::VPCGatewayAttachment", {
    VpcId: Match.anyValue(),
    InternetGatewayId: Match.anyValue(),
  });
  // Elastic IP
  template.resourceCountIs("AWS::EC2::EIP", 2);
  // NatGateway
  template.resourceCountIs("AWS::EC2::NatGateway", 2);
  template.hasResourceProperties("AWS::EC2::NatGateway", {
    AllocationId: Match.anyValue(),
    SubnetId: Match.anyValue(),
  });
  template.hasResourceProperties("AWS::EC2::NatGateway", {
    AllocationId: Match.anyValue(),
    SubnetId: Match.anyValue(),
  });
  // Route Table
  template.resourceCountIs("AWS::EC2::RouteTable", 6);
  template.resourceCountIs("AWS::EC2::Route", 4);
  template.hasResourceProperties("AWS::EC2::Route", {
    RouteTableId: Match.anyValue(),
    DestinationCidrBlock: "0.0.0.0/0",
    GatewayId: Match.anyValue(),
  });
  template.hasResourceProperties("AWS::EC2::Route", {
    RouteTableId: Match.anyValue(),
    DestinationCidrBlock: "0.0.0.0/0",
    NatGatewayId: Match.anyValue(),
  });
  template.resourceCountIs("AWS::EC2::SubnetRouteTableAssociation", 6);
  template.hasResourceProperties("AWS::EC2::SubnetRouteTableAssociation", {
    RouteTableId: Match.anyValue(),
    SubnetId: Match.anyValue(),
  });
});
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸçµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![jest](/images/cdk/jest.png)

## 5. AWS CDK Tips

### 5.1. Appå®šç¾©ã®Tips

#### 5.1.1. å…±é€šã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€æ‹¬ã§ä»˜ä¸ã—ãŸã„

Appå®šç¾©ã®æœ€å¾Œã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€Appå…¨ä½“ã§å…±é€šã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
// --------------------------------- Tagging  -------------------------------------
// ã“ã“ã‚’æŒ‡å®šã—ã¦ãŠãã¨ã€å…¨ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚¿ã‚°ä»˜ã‘ã—ã¦ãã‚Œã¾ã™ã€‚
// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚„ç’°å¢ƒè­˜åˆ¥å­ã¯å…±é€šã‚¿ã‚°ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚
cdk.Tags.of(this).add('Project', props.PJName);
cdk.Tags.of(this).add('Environment', props.EnvName);
```

ã‚¹ã‚¿ãƒƒã‚¯ç‰¹æœ‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚‹å ´åˆã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ã»ã†ã§æŒ‡å®šã—ã¾ã™ã€‚

```ts
export class MyStack extends Stack {
  // åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯ã§å‚ç…§
  public readonly xxx: string;

  constructor(scope: Construct, id: string, props: IMyStackProps) {
    super(scope, id, props);

    // ã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚‹ -> ã‚¹ã‚¿ãƒƒã‚¯å†…ã®å…¨ã¦ã«ã‚¿ã‚°ä»˜ã‘ã—ã¦ãã‚Œã¾ã™ã€‚
    cdk.Tags.of(this).add('hogehoge', 'foobar');
  }
}
```

#### 5.1.2. CDKã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«å‹•çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã„

CDKã‚³ãƒãƒ³ãƒ‰ã«`-c key=value`ã¨ã„ã†å½¢å¼ã§æŒ‡å®šã—ã¾ã™ã€‚è¤‡æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™å ´åˆã¯ã€`-c key1=value -c key2=value`ã®ã‚ˆã†ã«ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```sh
cdk deploy -c key=value
or
cdk deploy -c key1=value -c key2=value
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts
const key1: string = app.node.tryGetContext('key1');
const key2: string = app.node.tryGetContext('key2');
```

#### 5.1.3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ãŸç’°å¢ƒè­˜åˆ¥å­ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„

```ts
// ç’°å¢ƒè­˜åˆ¥å­ã®æŒ‡å®š -> ç’°å¢ƒè­˜åˆ¥å­ã¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« '-c project=xxx -c env=xxx' ã¨æŒ‡å®šã—ã¾ã™
const projectName: string = app.node.tryGetContext('project');
const envName: string = app.node.tryGetContext('env');

// ç’°å¢ƒè­˜åˆ¥å­ã®ãƒã‚§ãƒƒã‚¯
const envNames: string[] = ['dev', 'test', 'stage', 'prod'];
if (!envNames.includes(envName)) {
  console.error(`Invalid environment specified. Please use one of the following: ${envNames.join(', ')}.`);
  process.exit(1);
}
```

#### 5.1.4. æœ¬ç•ªç’°å¢ƒï¼ˆprodï¼‰ãƒªãƒªãƒ¼ã‚¹æ™‚ã«æ³¨æ„å–šèµ·ã—ã¦ãƒŸã‚¹ã‚’é˜²æ­¢ç­–ã—ãŸã„

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã¯ã€`cdk deploy MyStack -c env=dev --profile xxxxx` ã¨ã—ã¦ã€AWS ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ã“ã‚Œã ã¨ç’°å¢ƒè­˜åˆ¥å­ã‚„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’é–“é•ãˆã¦ã—ã¾ã£ãŸå ´åˆã€é–“é•ã£ãŸç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã—ã¾ã†å±é™ºãŒã‚ã‚Šã¾ã™ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§æ³¨æ„å–šèµ·ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹ã¨ã€ãã‚Œã ã‘ã§æ°—ä»˜ãã“ã¨ãŒã‚ã‚ŠãƒŸã‚¹é˜²æ­¢ã«ã‚‚ãªã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ env ã§ä¸ãˆã‚‰ã‚Œã‚‹ç’°å¢ƒã«ã‚ˆã£ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã§ã™ã€‚

`prod` ã¨ã—ãŸç’°å¢ƒã®å ´åˆã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![CAUTION](/images/cdk/cdk-CAUTION.png)

```ts
// æ–‡å­—è‰²
const color_red: string = "\u001b[31m";
const color_green: string = "\u001b[32m";
const color_yellow: string = "\u001b[33m";
const color_white: string = "\u001b[37m";
const color_reset: string = "\u001b[0m";

console.log();
console.log(
  `${color_yellow}##########################################${color_reset}`
);
console.log(`${color_yellow}  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ${projectName} ${color_reset}`);
console.log(
  `${color_yellow}  ãƒªãƒªãƒ¼ã‚¹ç’°å¢ƒï¼š${color_reset} ${color_red}${envname}${color_reset}`
);
console.log(
  `${color_yellow}##########################################${color_reset}`
);
console.log();

// ç’°å¢ƒè­˜åˆ¥å­ã®ãƒã‚§ãƒƒã‚¯
const envNames: string[] = ['dev', 'test', 'stage', 'prod'];
if (!envNames.includes(envName)) {
  console.error(`Invalid environment specified. Please use one of the following: ${envNames.join(', ')}.`);
  process.exit(1);
}

const isProduction: boolean = envname.match(/^(prod)$/) ? true : false;
if (isProduction) {
  console.log(`${color_red}!!!!!!!!!! CAUTION !!!!!!!!!!${color_reset}`);
  console.log(`${color_red}   æœ¬ç•ªç’°å¢ƒã¸ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚${color_reset}`);
  console.log(`${color_red}!!!!!!!!!! CAUTION !!!!!!!!!!${color_reset}`);
}
```

#### 5.1.5. ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤ã‚’é˜²æ­¢ã—ãŸã„

CloudFormationã«ã‚ã‚‹[ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html)ã‚’AWS CDKã‹ã‚‰æŒ‡å®šã™ã‚‹æ–¹æ³•ã§ã™ã€‚
å…·ä½“çš„ã«ã¯ã€`terminationProtection: true`ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆã¨åŒæ™‚ã«ã€å‰Šé™¤ä¿è­·ã‚’æœ‰åŠ¹ã«ã§ãã¾ã™ã€‚èª¤ã£ã¦`cdk deploy`ã—ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
ãŸã ã—ã€æœ¬å½“ã«å‰Šé™¤ã—ãŸã„å ´åˆã¯ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„AWS CLIï¼ˆ[update-termination-protection](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-termination-protection.html)ï¼‰ã‹ã‚‰å‰Šé™¤ä¿è­·ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts
// ã‚¹ã‚¿ãƒƒã‚¯
const myStack = new MyStack (app, 'MySample ', {
  terminationProtection: true, // å‰Šé™¤ä¿è­·ã®æœ‰åŠ¹åŒ–
});
```

#### 5.1.6. ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æŒ‡å®šã‚’å¤‰æ•°åŒ–

è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹å ´åˆã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¯å›æŒ‡å®šã™ã‚‹ã®ã§ã¯ãªãã¾ã¨ã‚ã¦å¤‰æ•°åŒ–ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

```ts
// env
const defaultEnv = {
  account: process.env.CDK_DEFAULT_ACCOUNT,
  region: process.env.CDK_DEFAULT_REGION,
};

// see: https://docs.aws.amazon.com/ja_jp/general/latest/gr/rande.html#regional-endpoints
const useast1Env = {
// US East (Virginia)
account: process.env.CDK_DEFAULT_ACCOUNT,
  region: "us-east-1", // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã—ãŸã„å ´åˆ
};

// stack1ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³
const stack1 = new MyStack (app, 'Stack1', {
  env: defaultEnv,
});

// stack2ã¯ãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
const stack2 = new MyStack (app, 'Stack2 ', {
  env: useast1Env,
});
```

#### 5.1.7. ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®è¨­å®šã‚’å®šç¾©ã§ãã¾ã™ã€‚

```typescript
const regionConfig = {
  'us-east-1': {
    name: 'Virginia',
    isPrimary: true,
    availabilityZones: ['us-east-1a', 'us-east-1b', 'us-east-1c'],
    certificateArn: 'arn:aws:acm:us-east-1:123456789012:certificate/uuid',
  },
  'eu-west-1': {
    name: 'Ireland',
    isPrimary: false,
    availabilityZones: ['eu-west-1a', 'eu-west-1b', 'eu-west-1c'],
    certificateArn: 'arn:aws:acm:eu-west-1:123456789012:certificate/uuid',
  },
  'ap-northeast-1': {
    name: 'Tokyo',
    isPrimary: false,
    availabilityZones: ['ap-northeast-1a', 'ap-northeast-1c', 'ap-northeast-1d'],
    certificateArn: 'arn:aws:acm:ap-northeast-1:123456789012:certificate/uuid',
  }
};

// Usage example
const deploymentRegions = ['us-east-1', 'ap-northeast-1']; // Selected regions for deployment

deploymentRegions.forEach(regionId => {
  const region = regionConfig[regionId];
  
  const networkStack = new NetworkStack(app, `${props.projectName}-${props.environment}-${region.name}-network`, {
    env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: regionId },
    availabilityZones: region.availabilityZones,
    isPrimary: region.isPrimary,
  });
  
  // Create other region-specific stacks...
});
```

### 5.2. AWS CDK Tips ãã®ä»–Tips

#### 5.2.1. ç’°å¢ƒè­˜åˆ¥å­ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã®äºŒé‡æŒ‡å®šã‚’ã‚„ã‚ã‚‹

ã€Œ5.1.3. æœ¬ç•ªç’°å¢ƒï¼ˆprodï¼‰ãƒªãƒªãƒ¼ã‚¹æ™‚ã«æ³¨æ„å–šèµ·ã—ã¦ãƒŸã‚¹ã‚’é˜²æ­¢ç­–ã—ãŸã„ã€ã§ã¯ã€`cdk deploy MyStack -c env=dev --profile xxxxx`ã®ã‚ˆã†ã«ã—ã¾ã—ãŸãŒã€ã“ã‚Œã§ã¯`profile`ã®æŒ‡å®šèª¤ã‚Šã‚’æ¤œçŸ¥ã§ãã¾ã›ã‚“ã€‚
å…·ä½“çš„ã«ã¯ã€`package.json`ã«ä»¥ä¸‹ã®å®šç¾©ã‚’ã—ã¦ã€`profile`ã‚’å‹•çš„ã«æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ãã®ãŸã‚ã«ã¯ã€`.aws\credentials`ã«ã€`--profile %npm_config_project%-%npm_config_env%"`ã§æŒ‡å®šã§ãã‚‹å½¢å¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```json
{
  :
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk",
    "cdk:synth": "cdk synth --version-reporting false --path-metadata false --asset-metadata false -c project=%npm_config_project% -c env=%npm_config_env% --profile %npm_config_project%-%npm_config_env%",
    "cdk:diff:all": "cdk diff --all --version-reporting false --path-metadata false --asset-metadata false -c project=%npm_config_project% -c env=%npm_config_env% --profile %npm_config_project%-%npm_config_env%",
    "cdk:deploy:all": "cdk deploy --all --version-reporting false --path-metadata false --asset-metadata false -c project=%npm_config_project% -c env=%npm_config_env% --profile %npm_config_project%-%npm_config_env%",
    "cdk:destroy:all": "cdk destroy --all -c project=%npm_config_project% -c env=%npm_config_env% --profile %npm_config_project%-%npm_config_env%"
  },
:
}
```

#### 5.2.2. AWS CDK ä½œæˆæ™‚ã® Metadata ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ

AWS CDK ã§ä½œæˆã•ã‚Œã‚‹ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¾ã™ã€‚[ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#version_reporting)ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚

```yaml
Resources:
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAAEzPUMzQw0TNQdEgsL9ZNTsnWT84vStWrDi5JTM7Wcc7PKy4pKk0u0XFOywtKLc4vLUpOBbGBEimZJZn5ebU6efkpqXpZxfplhmZ6hkCDsoozM3WLSvNKMnNT9YIgNAAtXENFZQAAAA==
    Metadata:
      aws:cdk:path: MyStack/CDKMetadata/Default
    Condition: CDKMetadataAvailable
Conditions:
  CDKMetadataAvailable:
    Fn::Or:
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - af-south-1
:
```

ã“ã‚Œã¯ã€æ¬¡ã®ã‚ˆã†ãªç›®çš„ã§ä»˜ä¸ã•ã‚Œã‚‹å†…å®¹ã§ã™ã€‚

![cdk-metadata.png](/images/cdk/cdk-metadata.png)

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ä»˜ä¸ã—ãŸããªã„å ´åˆã¯ã€cdk ã‚³ãƒãƒ³ãƒ‰ã«ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
cdk synth --no-version-reporting --path-metadata false
```

ã¾ãŸã¯ã€cdk.json ã« `"versionReporting": false,` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![versionReporting](/images/cdk/versionReporting.png)

GitHub ãªã©ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ããŸ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã“ã®ã‚ˆã†ãª Metadata ã®è¨˜è¼‰ãŒã‚ã‚‹å ´åˆã¯ã€æ¶ˆã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

## 6. cdk-nagã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®å¼·åŒ–

ã€ŒAmazon Web Services ãƒ–ãƒ­ã‚°>[AWS Cloud Development Kit ã¨ cdk-nag ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚’ç®¡ç†ã™ã‚‹](https://aws.amazon.com/jp/blogs/news/manage-application-security-and-compliance-with-the-aws-cloud-development-kit-and-cdk-nag/)ã€ã«ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã€Œcdk-nagã€ã‚’ä½¿ã£ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®å¼·åŒ–ã‚’è¡Œã†æ–¹æ³•ã§ã™ã€‚

### 6.1. cdk-nagã¨ã¯

`cdk-nag`ã¨ã¯ã€Œ[cfn_nag](https://github.com/stelligent/cfn_nag)ã€ã«å½±éŸ¿ã•ã‚ŒãŸé™çš„è§£æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

GitHubãƒªãƒã‚¸ãƒˆãƒªã¯[ã“ã¡ã‚‰](https://github.com/cdklabs/cdk-nag)

### 6.2. å°å…¥æ–¹æ³•

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ cdk-nag ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é–‹ç™ºä¾å­˜é–¢ä¿‚ï¼ˆdevDependenciesï¼‰ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm install cdk-nag --save-dev
or
npm install cdk-nag -D
```

### 6.3. å®Ÿè£…æ–¹æ³•

Appå®šç¾©(./bin/xxxxxx.ts)ã«æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€AWS Solutionsãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```ts
import "source-map-support/register";
import * as cdk from "aws-cdk-lib";
import { AwsSolutionsChecks } from "cdk-nag";
import { Stack1 } from "../lib/stack1";

const app = new cdk.App();
cdk.Aspects.of(app).add(new AwsSolutionsChecks());

const stack1 = new Stack1(app,'Stack1',{
  // ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®š
});
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ«ãƒ¼ãƒ«ã«æ²¿ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚

```sh
cdk synth
```

é•åã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã¤ãã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```text
[Error at /CdkTestStack/Bucket/Resource] AwsSolutions-S1: The S3 Bucket has server access logs disabled. The bucket should have server access logging enabled to provide detailed records for the requests that are made to the bucket.

[Error at /CdkTestStack/Bucket/Resource] AwsSolutions-S2: The S3 Bucket does not have public access restricted and blocked. The bucket should have public access restricted and blocked to prevent unauthorized access.

[Error at /CdkTestStack/Bucket/Resource] AwsSolutions-S3: The S3 Bucket does not default encryption enabled. The bucket should minimally have SSE enabled to help protect data-at-rest.

[Error at /CdkTestStack/Bucket/Resource] AwsSolutions-S10: The S3 Bucket does not require requests to use SSL. You can use HTTPS (TLS) to help prevent potential attackers from eavesdropping on or manipulating network traffic using person-in-the-middle or similar attacks. You should allow only encrypted connections over HTTPS (TLS) using the aws:SecureTransport condition on Amazon S3 bucket policies.

Found errors
```

å¯¾å¿œã™ã‚‹ã«ã¯ã€è©²å½“ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚’ä¿®æ­£ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`AwsSolutions-S3`ã«å¯¾å¿œã™ã‚‹ã«ã¯ã€`enforceSSL: true`ã‚’æŒ‡å®šã—ã¾ã™ã€‚ï¼ˆenforceSSLã¯æœªæŒ‡å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒfalseã§ã™ã€‚ï¼‰

â€»ç¾åœ¨ã¯ã€`AwsSolutions-S3`ã®ãƒ«ãƒ¼ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

```ts
const bucket = new Bucket(this, 'MyBucket', {
  :
+  enforceSSL: true
  }
)
```

### 6.4. Rules Pack

ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ãƒ«ãƒ¼ãƒ«ã¯GitHubãƒªãƒã‚¸ãƒˆãƒªã®[RULES.md](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md)ã«è¨˜è¼‰ãŒã‚ã‚‹ã‚ˆã†ã«ã€ä»¥ä¸‹ã®5ç¨®é¡ã«ãªã‚Šã¾ã™ã€‚

- [AWS Solutions](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md#awssolutions)
- [HIPAA security](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md#hipaa-security)
- [NIST 800-53 rev 4](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md#nist-800-53-rev-4)
- [NIST 800-53 rev 5](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md#nist-800-53-rev-5)
- [Payment Card Industry Data Security Standard (PCI DSS) 3.2.1](https://github.com/cdklabs/cdk-nag/blob/main/RULES.md#pci-dss-321)

ä½¿ç”¨ã™ã‚‹ã«ã¯ã€importã§ãƒ«ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```ts
import {
  AwsSolutionsChecks,
  HIPAASecurityChecks,
  NIST80053R4Checks,
  NIST80053R5Checks,
  PCIDSS321Checks,
} from 'cdk-nag';

Aspects.of(app).add(new AwsSolutionsChecks());
Aspects.of(app).add(new HIPAASecurityChecks());
Aspects.of(app).add(new NIST80053R4Checks());
Aspects.of(app).add(new NIST80053R5Checks());
Aspects.of(app).add(new PCIDSS321Checks());
```

ãƒ«ãƒ¼ãƒ«ã«ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }));
```

### 6.5. ã‚¨ãƒ©ãƒ¼ã®æŠ‘æ­¢

cdk-nagã§ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ã¯ã€ã‚ãã¾ã§ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å‰‡ã£ãŸã‚‚ã®ã§ã‚ã‚Šã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯é™¤å¤–ã—ãŸã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚
ãã®ã‚ˆã†ãªå ´åˆã€`NagSuppressions`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§é™¤å¤–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- addStackSuppressions
  - ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ã§é™¤å¤–ã™ã‚‹å ´åˆ
  - ã¾ãŸã¯ã€CDKãŒè‡ªå‹•çš„ã«ç”Ÿæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦é™¤å¤–ã™ã‚‹å ´åˆ
- addResourceSuppressions
  - ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ã¦é™¤å¤–ã™ã‚‹å ´åˆ
- addResourceSuppressionsByPath
  - ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‘ã‚¹åã‚’æŒ‡å®šã—ã¾ã™ã€‚

ç‰¹å®šã®ã‚¹ã‚¿ãƒƒã‚¯(./lib/stacks/xxxxx.ts)ã§æ¬¡ã®ã‚ˆã†ã«é™¤å¤–ã™ã‚‹ãƒ«ãƒ¼ãƒ«IDã‚’æŒ‡å®šã—ã¾ã™ã€‚

```ts
import { NagSuppressions } from "cdk-nag";

export class MyStack extends Stack {
  // åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯ã§å‚ç…§
  public readonly xxx: string;

  constructor(scope: Construct, id: string, props: IMyStackProps) {
    super(scope, id, props);

    const appLogsBucket = new Bucket(this, 'AppLogsBucket', { enforceSSL: true })
+    // ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ã§æŒ‡å®šã™ã‚‹å ´åˆ
+    NagSuppressions.addStackSuppressions(this, [
+      {
+        // ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãŒç„¡åŠ¹
+        id: 'AwsSolutions-S1',
+        reason: 'Demonstrate a stack level suppression.'
+      },
+    ]);

+    // ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã™ã‚‹å ´åˆ
+    NagSuppressions.addResourceSuppressions(this.bucket, [
+      {
+        // ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãŒç„¡åŠ¹
+        id: 'AwsSolutions-S1',
+        reason: 'Demonstrate a stack level suppression.'
+      },
+    ]);

+    // ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹å ´åˆ
+    NagSuppressions.addResourceSuppressionsByPath(this,
+    '/path/to/a/b/c/d/DefaultPolicy/Resource'
+    [
+      {
+        // ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãŒç„¡åŠ¹
+        id: 'AwsSolutions-S1',
+        reason: 'Demonstrate a stack level suppression.'
+      },
+    ]);
  }
}
```

### 6.6. ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ–¹æ³•

ä»¥ä¸‹ã¯ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰(./test/xxxxx.text.ts)ã®ä¾‹ã«ãªã‚Šã¾ã™ã€‚

```ts
import { Annotations, Match } from "aws-cdk-lib/assertions";
import { App, Aspects, Stack } from "aws-cdk-lib";
import { Stack1 } from "../lib/stack1";
import { AwsSolutionsChecks } from "cdk-nag";

describe("cdk-nag Aws Solutions Pack", () => {
  let stack: Stack;
  let app: App;
  beforeAll(() => {
    app = new App();
    stack = new Stack1(app, "test-stack",{
      // ã‚¹ã‚¿ãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    });

    Aspects.of(stack).add(new AwsSolutionsChecks());
  });

  test("No unsuppressed Warnings", () => {
    const Warnings = Annotations.fromStack(stack).findWarning(
      "*",
      Match.stringLikeRegexp("AwsSolutions-.*")
    );
    expect(Warnings).toHaveLength(0);
  });

  test("No unsuppressed Errors", () => {
    const errors = Annotations.fromStack(stack).findError(
      "*",
      Match.stringLikeRegexp("AwsSolutions-.*")
    );
    expect(errors).toHaveLength(0);
  });
});
```

### 6.7. ã€ç™ºå±•ã€‘CDK-NAGã¸ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ 

CDK-NAGã‚’ä½¿ã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã§ã™ã€‚`NagPack`ã‚’extendsã—ãŸã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€çµ„ç¹”ãªã©ã§è¦å®šã•ã‚Œã¦ã„ã‚‹ç‹¬è‡ªãƒ«ãƒ¼ãƒ«ã«å¯¾ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãŒå®Ÿæ–½ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€S3ã‚„EC2ã«ç‹¬è‡ªã®ã‚¿ã‚°ã‚’ä»˜ä¸ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ãƒ«ãƒ¼ãƒ«ãŒã‚ã£ãŸå ´åˆã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```ts
import { NagPack, NagMessageLevel,NagPackProps } from 'cdk-nag';
import * as cdk from 'aws-cdk-lib';
import { IConstruct } from 'constructs';;
import {
    aws_ec2 as ec2,
    aws_s3 as s3
 } from 'aws-cdk-lib';

export class CustomCdkNagRules extends NagPack {
    constructor(props?: NagPackProps) {
        super(props);
        this.packName = 'MyCompanyRules';
      }
    visit(node: IConstruct): void {
    if (node instanceof cdk.CfnResource) {
        // S3ãƒã‚±ãƒƒãƒˆã«ç‰¹å®šã®ã‚¿ã‚°ãŒå¿…è¦ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«
        this.applyRule({
            ruleSuffixOverride: 'S3BucketTaggingRule', // The rule ID.
            info: 'MyCompanyRule-S3-TAG-HOGEHOGE', //Why the rule was triggered.
            explanation: 'S3 ãƒã‚±ãƒƒãƒˆã«ã¯ hogehoge ã‚¿ã‚°ãŒå¿…è¦ã§ã™', // Why the rule exists.
            rule: (node: IConstruct) => {
                if (node instanceof s3.CfnBucket) {
                    // ã‚¿ã‚°ã®å­˜åœ¨ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯
                    const tags = node.tags?.renderTags();
                    if (!tags || !tags.some((tag: { key: string }) => tag.key === 'hogehoge')) {
                    return [node.logicalId];
                    }
                }
                return [];
            },
            level: NagMessageLevel.ERROR, // The annotations message level to apply to the rule if triggered.
            node: node,
        });
        // EC2ã«ç‰¹å®šã®ã‚¿ã‚°ãŒå¿…è¦ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«
        this.applyRule({
            ruleSuffixOverride: 'EC2TaggingRule', // The rule ID.
            info: 'MyCompanyRule-EC2-TAG-FOOBAR', //Why the rule was triggered.
            explanation: 'EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ foobar ã‚¿ã‚°ãŒå¿…è¦ã§ã™', // Why the rule exists.
            rule: (node: IConstruct) => {
                if (node instanceof ec2.CfnInstance) {
                    // ã‚¿ã‚°ã®å­˜åœ¨ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯
                    const tags = node.tags?.renderTags();
                    if (!tags || !tags.some((tag: { key: string }) => tag.key === 'foobar')) {
                    return [node.logicalId];
                    }
                }
                return [];
            },
            level: NagMessageLevel.ERROR, // The annotations message level to apply to the rule if triggered.
            node: node,
        });
    }
  }
}
```

ãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€`AwsSolutionsChecks`ã¨åŒæ§˜ã®æ–¹æ³•ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

```ts
import { AwsSolutionsChecks } from 'cdk-nag'
import { Aspects } from 'aws-cdk-lib';
+ import { CustomCdkNagRules } from '/path/to/custom-cdk-nag-rules';

// Add the cdk-nag AwsSolutions Pack with extra verbose logging enabled.
Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }))
+ Aspects.of(app).add(new CustomCdkNagRules({ verbose: true }));
```

å®Ÿè¡Œã™ã‚‹ã¨ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```text
[Error at /SampleStack/LogsBucket/S3Bucket/Resource] MyCompanyRules-S3BucketTaggingRule[LogsBucketS3BucketD57C9602]: MyCompanyRule-S3-TAG-HOGEHOGE S3 ãƒã‚±ãƒƒãƒˆã«ã¯ hogehoge ã‚¿ã‚°ãŒå¿…è¦ã§ã™
[Error at /SampleStack/EC2Instance1/Resource] MyCompanyRules-EC2TaggingRule[EC2Instance14196AB1A]: MyCompanyRule-EC2-TAG-FOOBAR EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ foobar ã‚¿ã‚°ãŒå¿…è¦ã§ã™
```

## ğŸ“– ã¾ã¨ã‚

AWS CDKã¯ã€ä½¿ã„æ…£ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’æ´»ç”¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å®šç¾©ã™ã‚‹å¼·åŠ›ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€AWS CDKã®åŸºæœ¬æ¦‚å¿µã‹ã‚‰é«˜åº¦ãªä½¿ç”¨æ–¹æ³•ã¾ã§å¹…åºƒãè§£èª¬ã—ã¾ã—ãŸã€‚
CDKã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã®ä¸»ãªãƒ¡ãƒªãƒƒãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- é™çš„å‹ä»˜ãè¨€èªã«ã‚ˆã‚‹å‹å®‰å…¨æ€§ã¨æ—©æœŸã®ã‚¨ãƒ©ãƒ¼æ¤œå‡º
- ã‚³ãƒ¼ãƒ‰å†åˆ©ç”¨ã«ã‚ˆã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®æ¨™æº–åŒ–ã¨å“è³ªå‘ä¸Š
- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®æ©Ÿèƒ½ï¼ˆæ¡ä»¶åˆ†å²ã€ãƒ«ãƒ¼ãƒ—ã€æŠ½è±¡åŒ–ï¼‰ãŒæ´»ç”¨ã§ãã‚‹é–‹ç™ºç”Ÿç”£æ€§
- ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®çµ±åˆã«ã‚ˆã‚‹ä¸€å…ƒç®¡ç†
- çµ„ç¹”å…¨ä½“ã§ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¨ã‚¬ãƒãƒŠãƒ³ã‚¹å¼·åŒ–

ç‰¹ã«L2ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€CloudFormationã§ã¯æ•°ç™¾è¡Œã«åŠã¶ã‚³ãƒ¼ãƒ‰ãŒæ•°åè¡Œã§å®Ÿç¾ã§ãã€å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

ã¾ãŸã€cdk-nagã‚„ã€åŠ¹ç‡çš„ãªé–‹ç™ºã®ãŸã‚ã®å‘½åè¦å‰‡ã€ç’°å¢ƒè­˜åˆ¥æ–¹æ³•ãªã©ã®å®Ÿè·µçš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å¤§è¦æ¨¡ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„çµ„ç¹”å…¨ä½“ã§ã®CDKã®æ´»ç”¨ã«å½¹ç«‹ã¡ã¾ã™ã€‚

AWS CDKã‚’é©åˆ‡ã«æ´»ç”¨ã—ã€å®‰å…¨ã§å …ç‰¢ã€ã‹ã¤åŠ¹ç‡çš„ãªã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç®¡ç†ã‚’å®Ÿç¾ã—ã¾ã—ã‚‡ã†ã€‚