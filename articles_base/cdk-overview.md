# AWS CDK

## â˜˜ï¸ ã¯ã˜ã‚ã«

æœ¬ãƒšãƒ¼ã‚¸ã¯ã€AWS ã«é–¢ã™ã‚‹å€‹äººã®å‹‰å¼·ãŠã‚ˆã³å‹‰å¼·ä¼šã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«ã€AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’å‚ç…§ã—ä½œæˆã—ã¦ãŠã‚Šã¾ã™ãŒã€è¨˜è¼‰ã®èª¤ã‚Šç­‰ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚

æœ€æ–°ã®æƒ…å ±ã«ã¤ã„ã¦ã¯ã€AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚

## ğŸ‘€ Contents

Duration: 00:01:00

- [AWS CDK](#aws-cdk)
  - [â˜˜ï¸ ã¯ã˜ã‚ã«](#ï¸-ã¯ã˜ã‚ã«)
  - [ğŸ‘€ Contents](#-contents)
  - [xx ã¨ã¯](#xx-ã¨ã¯)
  - [xx ã®åŸºæœ¬](#xx-ã®åŸºæœ¬)

## AWS CDK ã¨ã¯

Duration: 2:31:03

AWS Cloud Development Kit ã®ã“ã¨ã§ã€ä½¿ã„æ…£ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

ã€AWS Black Belt Online Seminarã€‘[AWS CDK ã®é–‹ç™ºã‚’åŠ¹ç‡åŒ–ã™ã‚‹æ©Ÿèƒ½ (Basic #3)(YouTube)](https://youtu.be/z3Mst77p-aU)(0:29:20)[PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-3-AppDev_0831_v1.pdf)

![xx](/images/blackbelt/)

ã€AWS Black Belt Online Seminarã€‘[AWS CDK ã®åŸºæœ¬çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨æ©Ÿèƒ½ (Basic #2)(YouTube)](https://youtu.be/aqa2bFFzcjs)(0:28:13)[PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-2-Features_0831_v1.pdf)

![xx](/images/blackbelt/)

ã€AWS Black Belt Online Seminarã€‘[AWS CDK æ¦‚è¦ (Basic #1)(YouTube)](https://youtu.be/BmCpa44rAXI)(0:33:07)[PDF](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CDK-Basic-1-Overview_0731_v1.pdf)

![xx](/images/blackbelt/)

ã€AWS Black Belt Online Seminarã€‘[AWS Cloud Development Kit (CDK)(YouTube)](https://youtu.be/1i7kWqpqtoY)(1:01:23)

![xx](/images/blackbelt/)


[AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ](https://aws.amazon.com/jp/cdk/)

[AWS CDK Reference Documentation](https://docs.aws.amazon.com/cdk/api/v2/)

[AWS CDK DEVELOPER GUIDE](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)

[AWS CDK API REFERENCE](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html)

[AWS Cloud Development Kit ã®ã‚ˆãã‚ã‚‹è³ªå•](https://aws.amazon.com/jp/cdk/faqs/)


## CDK v2

Duration: 0:01:30

CDK ã® v2 ã¯ã€2021å¹´ 5æœˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Ÿæ–½ã•ã‚Œã€ 2021å¹´ 12æœˆ 2æ—¥ã« GA ã•ã‚Œã¾ã—ãŸã€‚

AWS Cloud Development Kit v2 é–‹ç™ºè€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãŠçŸ¥ã‚‰ã›
https://aws.amazon.com/jp/blogs/news/announcing-aws-cloud-development-kit-v2-developer-preview/

AWS Cloud Development Kit (AWS CDK) v2 ã®ä¸€èˆ¬æä¾›é–‹å§‹
https://aws.amazon.com/jp/about-aws/whats-new/2021/12/aws-cloud-development-kit-cdk-generally-available/

v2 ã§ã¯Construct ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ aws-cdk-lib ã«å˜ä¸€åŒ–ã•ã‚ŒãŸãŸã‚ã€v1 ã§å®Ÿæ–½ã—ã¦ã„ãŸå€‹ã€…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚

v1 ã§ã¯å€‹åˆ¥ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸãŸã‚ã€å¾Œã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãªã„ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã‚‹ãŸã‚ã«ã€ã€Œnpm install @aws-cdk/aws-lambda@1.111.0ã€ã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

```ts
npm install @aws-cdk/aws-lambda
npm install @aws-cdk/aws-cloudfront
npm install @aws-cdk/aws-iam
npm install @aws-cdk/aws-s3


import * as cdk from "@aws-cdk/core";
import * as cloudfront from "@aws-cdk/aws-cloudfront";
import * as s3 from "@aws-cdk/aws-s3";
import * as iam from "@aws-cdk/aws-iam";
```

v2 ã§ã¯å˜ä¸€ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«çµ±åˆã•ã‚ŒãŸãŸã‚ã€å€‹åˆ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãªãä½¿ç”¨ã§ãã¾ã™ã€‚

```ts
npm install aws-cdk-lib

import {
  aws_s3 as s3,
  aws_iam as iam,
  aws_cloudfront as cloudfront,
from "aws-cdk-lib";
```

## å¯¾å¿œè¨€èª

- TypeScript
- JavaScript
- Python
- Java
- C#/.NET

## CDK ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—

æ‰‹ã‚’å‹•ã‹ã—ã¦å­¦ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

https://cdkworkshop.com/

## æ§‹æˆè¦ç´ 

### App

CDK ã®æœ€ä¸Šä½å±¤ã§ã€è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ä¾å­˜é–¢ä¿‚ãªã©ã‚’å®šç¾©ã—ã¾ã™ã€‚

### Stack

CloudFormation ã®ã‚¹ã‚¿ãƒƒã‚¯ã«å¯¾å¿œã—ã¾ã™ã€‚AWSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã“ã®ã‚¹ã‚¿ãƒƒã‚¯å˜ä½ã§è¡Œã„ã¾ã™ã€‚

### Construct

Stack å±¤ã« AWS ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã‚’ä½œæˆã—ã¾ã™ã€‚

Construct ã«ã¯3ã¤ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

- L1 Construct(Low Level Construct)
- L2 Construct(High Level Construct)
- L3 Construct(Patterns)

#### L1 Construct / L2 Construct

L1 Construct ã¨ã¯ã€Low Level Construct ã®ã“ã¨ã§ã™ã€‚CloudFormation ã®å„ãƒªã‚½ãƒ¼ã‚¹ã¨ 1:1 ã®é–¢ä¿‚ã«ãªã£ã¦ã„ã¾ã™ã€‚

CloudFormation ã§å®šç¾©ã™ã‚‹ã®ã¨åŒã˜ãƒ¬ãƒ™ãƒ«ã§ã®è¨˜è¼‰ã«ãªã‚Šã¾ã™ã€‚L2 Construct ãŒå­˜åœ¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ã€L2 Construct ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ãŒã€è¦ä»¶ã«å¿œã˜ãŸç´°ã‹ã„è¨­å®šãŒå¿…è¦ãªå ´åˆã¯ã€L1 Construct ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/constructs.html#constructs_l1_using

```ts
const bucket = new s3.CfnBucket(this, "MyBucket", {
  bucketName: "MyBucket"
});
```

L2 Construct ã¨ã¯ã€High Level Construct ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€L1 Construct ã‚’ãƒ©ãƒƒãƒ—ã—ãŸ Construct ã§ã™ã€‚

https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/constructs.html#constructs_using

```ts
import * as s3 from 'aws-cdk-lib/aws-s3';

const bucket = new s3.Bucket(this, 'MyBucket', {
  versioned: true
});
```

TypeScript ã‚’ä½¿ç”¨ã—ã¦ã€VPC ã‚’ä½œã‚‹å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ã ã‘ã§ã€VPCã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã€NAT ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã€ã‚µãƒ–ãƒãƒƒãƒˆ 6ã¤ï¼ˆ3ç¨®é¡ Ã— maxAzsæ•°åˆ†ï¼‰ ã® CloudFormation å®šç¾©ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚CloudFormation ã§è¨˜è¿°ã™ã‚‹ã¨ 430 è¡Œã«ã‚‚ãªã‚‹å®šç¾©ãŒ 12 è¡Œã ã‘ã§å®Œäº†ã—ã¾ã™ã€‚

cidrMask ã®æ•°å­—ã ã‘æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€ã‚µãƒ–ãƒãƒƒãƒˆã® CIDR ãƒ–ãƒ­ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚CIDR ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç‰¹å®šã®å€¤ã§æŒ‡å®šã—ãŸã„å ´åˆã¯ã€L1 Construct ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```ts
const vpc = new ec2.Vpc(this, 'vpc', {
  vpcName: 'vpc',
  cidr: '10.0.0.0/16',
  natGateways: 2,
  natGatewaySubnets: {subnetType: ec2.SubnetType.PUBLIC},
  maxAzs: 2,
  subnetConfiguration: [
    {subnetType: ec2.SubnetType.PUBLIC, name:'public', cidrMask: 20},
    {subnetType: ec2.SubnetType.PRIVATE_WITH_NAT, name:'private', cidrMask: 19},
    {subnetType: ec2.SubnetType.PRIVATE_ISOLATED, name:'protected', cidrMask: 21},
  ],
});
```

ã“ã®å®šç¾©ã‚’å®Ÿè¡Œã—ãŸå ´åˆã«ç”Ÿæˆã•ã‚Œã‚‹ CloudFormation ã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚


![](images/cdk/vpc_cfn_00.png)
ï¼š
ï¼š
![](images/cdk/vpc_cfn_01.png)

#### Patterns

L3 Constructã¨ã—ã¦ã€ECS Patternsã®ã‚ˆã†ã«ECSé–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç°¡å˜ã«ç”Ÿæˆã§ãã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã ã‘ã§ã€ECSã‚µãƒ¼ãƒ“ã‚¹ã€ALBã€é–¢é€£ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚¿ã‚¹ã‚¯ç”¨ã®IAMãƒ­ãƒ¼ãƒ«ãªã© 200ï½300è¡Œã® CloudFormation ã®ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚

```ts
// ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆ
const cluster = new ecs.Cluster(this, 'MyCluster', {
  vpc: props.vpc,
});

const loadBalancedFargateService =new ecs_patterns.ApplicationLoadBalancedFargateService(this, 'MyFargateService',{
  cluster: cluster,
  cpu: 4096,
  memoryLimitMiB: 30720,
  publicLoadBalancer: true,
  desiredCount: 6,
  taskImageOptions:
  {
    image: ecs.ContainerImage.fromRegistry("amazon/amazon-ecs-sample"),
  },
});
```

## Unit Test

Jest ã‚’ä½¿ã£ãŸ Unit Test ã‚‚å®Ÿæ–½ã§ãã¾ã™ã€‚VPC ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ VPC ã‚„ã‚µãƒ–ãƒãƒƒãƒˆã®æ•°ã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ãªã©ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã€"AWS::EC2::VPC" ã®ã‚ˆã†ã« AWS ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’çŸ¥ã£ã¦ã„ãªã„ã¨ã„ã‘ãªã„ã®ã§æ…£ã‚Œãªã„ã†ã¡ã¯æ‰‹é–“å–ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```ts
test('create the vpc', () => {
    // GIVEN
    const app = new App({
        context : {
            'PJName': 'junit',
            'EnvName': 'prod',
            'CidrBlock': '10.0.0.0/16',
        }
    });
    const stack = new VPCStack(app, 'testing-vpcstack', {});
    // WHEN
    const template = Template.fromStack(stack);

    // THEN
    // VPC
    template.resourceCountIs('AWS::EC2::VPC', 1);
    template.hasResourceProperties('AWS::EC2::VPC', {
        CidrBlock: '10.0.0.0/16',
    });

    // Subnet
    template.resourceCountIs('AWS::EC2::Subnet', 6);
    // Internet Gateway
    template.resourceCountIs('AWS::EC2::InternetGateway', 1);
    template.resourceCountIs('AWS::EC2::VPCGatewayAttachment', 1);
    template.hasResourceProperties('AWS::EC2::VPCGatewayAttachment', {
        VpcId: Match.anyValue(),
        InternetGatewayId: Match.anyValue()
    });
    // Elastic IP
    template.resourceCountIs('AWS::EC2::EIP', 2);
    // NatGateway
    template.resourceCountIs('AWS::EC2::NatGateway', 2);
    template.hasResourceProperties('AWS::EC2::NatGateway', {
        AllocationId: Match.anyValue(),
        SubnetId: Match.anyValue(),
    });
    template.hasResourceProperties('AWS::EC2::NatGateway', {
        AllocationId: Match.anyValue(),
        SubnetId: Match.anyValue(),
    });
    // Route Table
    template.resourceCountIs('AWS::EC2::RouteTable', 6);
    template.resourceCountIs('AWS::EC2::Route', 4);
    template.hasResourceProperties('AWS::EC2::Route', {
        RouteTableId: Match.anyValue(),
        DestinationCidrBlock: '0.0.0.0/0',
        GatewayId: Match.anyValue()
    });
    template.hasResourceProperties('AWS::EC2::Route', {
        RouteTableId: Match.anyValue(),
        DestinationCidrBlock: '0.0.0.0/0',
        NatGatewayId: Match.anyValue()
    });
    template.resourceCountIs('AWS::EC2::SubnetRouteTableAssociation', 6);
    template.hasResourceProperties('AWS::EC2::SubnetRouteTableAssociation', {
        RouteTableId: Match.anyValue(),
        SubnetId: Match.anyValue()
    });

});
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸçµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](images/cdk/jest.png)


## CDK ã®ã‚³ãƒãƒ³ãƒ‰

- cdk deploy
  https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-deploy
  CDK ã§å®šç¾©ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ AWS ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
  ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ã€```--all``` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚
  æŒ‡å®šã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ã€deploy ã®å¾Œã«ã‚¹ã‚¿ãƒƒã‚¯åã‚’æŒ‡å®šã—ã¾ã™ã€‚
- cdk diff
  https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-diff
  ç¾åœ¨ã® CDK ã¨ã™ã§ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å¤‰æ›´ç‚¹ã‚’ä¸€è¦§ã§å–å¾—ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
- cdk synth
  https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-synth
  CDK ã§å®šç¾©ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
  ãƒªã‚½ãƒ¼ã‚¹ã«ä»˜ä¸ã•ã‚Œã‚‹ Metadata ã‚’å‰Šé™¤ã—ãŸã„å ´åˆã¯ã€```--path-metadata false``` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å‡ºåŠ›ã›ãšã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã«è¨˜è¿°ã—ãŸ console.log() ã ã‘ç¢ºèªã—ãŸã„å ´åˆã¯ã€ ```--quit``` ã¾ãŸã¯ ```-q``` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
- cdk ls
  https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cli.html#cli-list
  ç¾åœ¨ã® CDK ã‚¢ãƒ—ãƒªã«å«ã¾ã‚Œã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

## CDK ä½œæˆæ™‚ã® Metadata ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ

cdk.json ã« ```"versionReporting": false,``` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![](images/cdk/versionReporting.png)


